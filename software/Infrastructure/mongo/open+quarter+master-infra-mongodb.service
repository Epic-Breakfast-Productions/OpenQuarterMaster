# Service file for running an instance of MongoDB.
#  Author: Greg Stewart
#  https://www.freedesktop.org/software/systemd/man/systemd.service.html
#
#  Mongo tags: https://hub.docker.com/_/mongo?tab=tags
#
#  TODO:: figure out better username/password situation
#    - https://lzone.de/blog/Using-Linux-keyring-secrets-from-your-scripts
#
# TODO:: Figure out what's wrong on first run to cause issues with base station complaining about not being primary or secondary

[Unit]
Description=Mongo server for Open Quartermaster. Version ${version}, using MongoDB tagged to "4".
Documentation=https://github.com/Epic-Breakfast-Productions/OpenQuarterMaster/tree/main/software/Infrastructure
After=docker.service
Wants=network-online.target docker.socket
Requires=docker.socket

[Service]
Type=simple
Restart=always
TimeoutSec=5m

#ExecStartPre=/bin/bash -c "/usr/bin/docker container inspect oqm_mongo 2> /dev/null || "
ExecStartPre=/bin/bash -c "/usr/bin/docker stop -t 10 oqm_infra_mongo || echo 'Could not stop mongo container'"
ExecStartPre=/bin/bash -c "/usr/bin/docker rm oqm_infra_mongo || echo 'Could not remove mongo container'"
ExecStartPre=/bin/bash -c "/usr/bin/docker pull mongo:4 || echo 'Could not pull image.'"
# setup env list file
ExecStartPre=/bin/bash -c "mkdir -p /tmp/oqm/serviceConfig/infra/mongodb"
ExecStartPre=/bin/bash -c "touch /tmp/oqm/serviceConfig/infra/mongodb/env.list"
ExecStartPre=/bin/bash -c "chmod 600 /tmp/oqm/serviceConfig/infra/mongodb/env.list"
ExecStartPre=/bin/bash -c "truncate -s 0 /tmp/oqm/serviceConfig/infra/mongodb/env.list"
ExecStartPre=/bin/bash -c "printf \"MONGO_INITDB_ROOT_USERNAME=$(oqm-config -g 'infra.mongodb.adminUser')\n\" >> /tmp/oqm/serviceConfig/infra/mongodb/env.list"
ExecStartPre=/bin/bash -c "printf \"MONGO_INITDB_ROOT_PASSWORD=$(oqm-config -g 'infra.mongodb.adminPass')\n\" >> /tmp/oqm/serviceConfig/infra/mongodb/env.list"
#ExecStartPre=/bin/bash -c "printf \"Test! MONGO_INITDB_ROOT_PASSWORD=$(oqm-config -g 'infra.mongodb.adminPass')\n\""
ExecStartPre=/bin/bash -c "mkdir -p /data/oqm/db/mongo/"
ExecStartPre=/bin/bash -c "touch /data/oqm/db/mongo/keyfile"
ExecStartPre=/bin/bash -c "chmod 600 /data/oqm/db/mongo/keyfile"
ExecStartPre=/bin/bash -c "printf \"%s\" \"$(oqm-config -g 'infra.mongodb.keyFileContent' | base64)\" > /data/oqm/db/mongo/keyfile"

ExecStart=/bin/bash -c "/usr/bin/docker run \
                                 --name oqm_infra_mongo \
                                 -p=27017:27017 \
                                 -v /data/oqm/db/mongo/:/data/db  \
                                 --env-file /tmp/oqm/serviceConfig/infra/mongodb/env.list \
                                 mongo:4 mongod --keyFile /data/db/keyfile --replSet rs0"
ExecStartPost=/bin/bash -c "running=\"false\"; \
                            while [ \"$running\" != \"true\" ]; do \
                                sleep 1s; \
                                /usr/bin/docker exec oqm_infra_mongo mongo --eval \"\"; \
                                if [ \"$?\" = \"0\" ]; then \
                                    echo \"Mongo container running and available!\"; \
                                    running=\"true\"; \
                                fi \
                            done \
                            "
ExecStartPost=/bin/bash -c "/usr/bin/docker exec oqm_infra_mongo mongo -u \"$(oqm-config -g 'infra.mongodb.adminUser')\" -p \"$(oqm-config -g 'infra.mongodb.adminPass')\" --eval \"rs.initiate({'_id':'rs0', 'members':[{'_id':0,'host':'localhost:27017'}]})\" || echo 'Probably already initialized.'"

ExecStop=/bin/bash -c "/usr/bin/docker stop -t 10 oqm_infra_mongo || echo 'Could not stop mongo container'"
ExecStopPost=/bin/bash -c "/usr/bin/docker rm oqm_infra_mongo || echo 'Could not remove mongo container'"

[Install]
WantedBy=multi-user.target
