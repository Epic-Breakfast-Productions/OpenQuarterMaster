<!DOCTYPE html>
<html lang="en">
<head>
	<title>Storagotchi - Open QuarterMaster</title>
	<meta charset="UTF-8"/>
	
	<link rel="stylesheet" href="/lib/xp.css/0.2.6/XP.css"/>
	<style>
		html {
			height: 100%;
		}
		
		body {
			min-height: 100vh;
			background-image: url(/media/background/windows_xp_original-wallpaper.jpg);
			background-size: cover;
			background-repeat: no-repeat;
		}
		
		#mainWindow {
			width: 95vw; /* 100% of the viewport width */
			height: 95vh;
		}
		
		#mainWindowBody {
			margin-bottom: 0px;
			/*height: 100%;*/
		}
		
		dialog.window {
			border-width: 0;
		}
		
		#gameCanvas {
			width: 100%;
			min-height: 100%;
			/*border: 1px solid black;*/
		}
	</style>
</head>

<body class="">
<div class="window" id="mainWindow">
	<div class="title-bar">
		<div class="title-bar-text">
			Storagotchi
		</div>
		<div class="title-bar-controls">
			<button id="testModalOpenButton" aria-label="Help"></button>
			<button aria-label="Minimize" disabled></button>
			<button aria-label="Restore" disabled></button>
			<button aria-label="Close" disabled></button>
		</div>
	</div>
	<div class="window-body" id="mainWindowBody">
		<section class="tabs" style="max-width: 100%; height: 100%;" id="mainTabs">
			<menu role="tablist" aria-label="Navigation">
				<button role="tab" aria-selected="true" aria-controls="tab-game">Storagotchi</button>
				<button role="tab" aria-controls="tab-guide">Guide</button>
				<button role="tab" aria-controls="tab-options">Options</button>
			</menu>
			<!-- the tab content -->
			<article role="tabpanel" id="tab-game" class="tabContent">
				<div id="gameCanvas"></div>
			</article>
			<article role="tabpanel" id="tab-guide" class="tabContent" hidden>
				<h3>Tab 3</h3>
				<p>Lorem Ipsum Dolor Sit</p>
			</article>
			<article role="tabpanel" id="tab-options" class="tabContent" hidden>
				<h3>More...</h3>
				<p>This tab contains a GroupBox</p>
				<fieldset>
					<legend>Today's mood</legend>
					<div class="field-row">
						<input id="radio10" type="radio" name="fieldset-example2">
						<label for="radio10">Claire Saffitz</label>
					</div>
					<div class="field-row">
						<input id="radio11" type="radio" name="fieldset-example2">
						<label for="radio11">Brad Leone</label>
					</div>
					<div class="field-row">
						<input id="radio12" type="radio" name="fieldset-example2">
						<label for="radio12">Chris Morocco</label>
					</div>
					<div class="field-row">
						<input id="radio13" type="radio" name="fieldset-example2">
						<label for="radio13">Carla Lalli Music</label>
					</div>
				</fieldset>
			</article>
		</section>
	</div>
	{!<div style="height: 100%;"></div>!}
	<div class="status-bar" style="margin-top: auto; margin-bottom: 0;">
		<p class="status-bar-field">Press F1 for help</p>
		<p class="status-bar-field">Slide 1</p>
		<p class="status-bar-field">CPU Usage: 14%</p>
		<p class="status-bar-field" style="max-width: 125px;">
			<progress></progress>
		</p>
	</div>
</div>


<dialog class="window" style="width: 250px" id="testDialog">
	<div class="title-bar">
		<div class="title-bar-text">Info</div>
		<div class="title-bar-controls">
			<button type="button" aria-label="Close" class="modalClose"></button>
		</div>
	</div>
	<div class="window-body">
		<h3>Storagotchi</h3>
		<p>
			A fun digital dude to help you stay motivated with your inventory management.
		</p>
		<p>
			Version 1.0.0-SNAPSHOT TODO
		</p>
		<p>
			&copy; 2025 <a href="https://epic-breakfast-productions.tech">Epic Breakfast Productions</a>
		</p>
		<p>
			Source on <a href="https://github.com/Epic-Breakfast-Productions/OpenQuarterMaster/tree/main/software/plugins/storagotchi/">Open QuarterMaster Github</a>
		</p>
	</div>
</dialog>

<script src="/webjars/jquery/3.7.1/jquery.min.js"></script>
<script>
	const testDialog = $("#testDialog");
	
	const showButton = $("#testModalOpenButton");
	const closeButton = testDialog.find(".modalClose");
	
	// "Show the dialog" button opens the dialog modally
	showButton.on("click", () => {
		console.log("Opening test modal");
		testDialog[0].showModal();
	});
	
	// "Close" button closes the dialog
	closeButton.on("click", () => {
		console.log("Closing test modal");
		testDialog[0].close();
	});
	
	
	const tabs = document.querySelectorAll("menu[role=tablist]");
	
	for (let i = 0; i < tabs.length; i++) {
		const tab = tabs[i];
		
		const tabButtons = tab.querySelectorAll("menu[role=tablist] > button");
		
		tabButtons.forEach((btn) =>
			btn.addEventListener("click", (e) => {
				e.preventDefault();
				
				tabButtons.forEach((button) => {
					if (
						button.getAttribute("aria-controls") ===
						e.target.getAttribute("aria-controls")
					) {
						button.setAttribute("aria-selected", true);
						openTab(e, tab);
					} else {
						button.setAttribute("aria-selected", false);
					}
				});
			})
		);
	}
	
	function openTab(event, tab) {
		const articles = tab.parentNode.querySelectorAll('[role="tabpanel"]');
		articles.forEach((p) => {
			p.setAttribute("hidden", true);
		});
		const article = tab.parentNode.querySelector(
			`[role="tabpanel"]#` + event.target.getAttribute("aria-controls")
		);
		article.removeAttribute("hidden");
	}

</script>
<script type="module">
	import * as PIXI from '/lib/pixi/8.14.0/pixi.min.mjs';
	
	//boxes
	const NUM_BOXES = 10;
	const BOX_DISTANCE_THRESHOLD = 100;
	const BOX_WIDTH_MOD = 0.03;
	
	//stuff
	const STUFF_DISTANCE_THRESHOLD = 100;
	const STUFF_WIDTH_MOD = 0.02;
	
	//storagotchi
	const SG_WIDTH_MOD = 0.03;
	
	const gameState = {
		oqmActionCount: 0
	};
	
	
	// Create a new application
	const app = new PIXI.Application();
	const boxes = [];
	let storagotchi = null;
	
	
	(async () => {
		await preload();
		await initApp();
		
		setupBackdrop();
		setupBoxes();
		setupStoragotchi();
		
		// Listen for animate update
		app.ticker.add((time) => {
			animateStoragotchi(app, time, time.deltaTime);
		});
	})();
	
	async function preload() {
		// Create an array of asset data to load.
		const assets = [
			{ alias: 'storagotchi-1', src: '/media/sprites/storagotchi/storagotchi-0.png'},
			{ alias: 'box-1-closed', src: '/media/sprites/box/box-1-closed.png'},
			{ alias: 'box-1-open', src: '/media/sprites/box/box-1-open.png'},
			{ alias: 'box-2-closed', src: '/media/sprites/box/box-2-closed.png'},
			{ alias: 'box-2-open', src: '/media/sprites/box/box-2-open.png'},
			{ alias: 'box-3-closed', src: '/media/sprites/box/box-3-closed.png'},
			{ alias: 'box-3-open', src: '/media/sprites/box/box-3-open.png'},
		];
		
		// Load the assets defined above.
		await PIXI.Assets.load(assets);
	}
	
	async function initApp() {
		let gameCanvas = document.getElementById("gameCanvas");
		
		// Initialize the application
		await app.init({
			backgroundAlpha: 0,
			// background: '#ece9d8', //beige
			resizeTo: gameCanvas
		});
		
		// Append the application canvas to the document body
		gameCanvas.appendChild(app.canvas);
	}
	
	function setupBackdrop() {
		const gradient = new PIXI.FillGradient({
			end: { x: 1, y: 0},
			colorStops: [
				{ offset: 0, color: 0xff0000}, // Red at start
				{ offset: 0.5, color: 0x00ff00}, // Green at middle
				{ offset: 1, color: 0x0000ff}, // Blue at end
			],
		});
		
		const graphics = new PIXI.Graphics();
		
		graphics.circle(app.screen.width / 2, app.screen.height / 2, 100)
			.fill({ fill: gradient})
		
		app.stage.addChild(graphics);
	}
	
	function randomIntFromInterval(min, max) { // min and max included
		return Math.floor(Math.random() * (max - min + 1) + min);
	}
	
	
	function spriteNear(sprite, x, y, radius) {
		const dx = sprite.x - x;
		const dy = sprite.y - y;
		const distance = Math.sqrt((dx * dx) + (dy * dy));
		return distance <= radius;
	}
	
	function spritesNear(sprite1, sprite2, radius) {
		return spriteNear(sprite1, sprite2.x, sprite2.y, radius);
	}
	
	function spriteNearThings(sprite, radius = 100) {
		//not near center
		if (spriteNear(sprite, app.screen.width / 2, app.screen.height / 2, radius)) {
			console.debug("Sprite near center.");
			return true;
		}
		for (let box in boxes) {
			if (spritesNear(sprite, boxes[box], radius)) {
				console.debug("Sprite near box.");
				return true;
			}
		}
		
		return false;
	}
	
	function setupBoxes() {
		for (let i = 0; i < NUM_BOXES; i++) {
			let box = PIXI.Sprite.from('box-' + (Math.floor(Math.random() * 3) + 1) + "-closed");
			box.anchor.set(0.5, 0.5);
			box.width = app.screen.width * BOX_WIDTH_MOD;
			box.scale.y = box.scale.x;
			
			
			do {
				let x = randomIntFromInterval(50, app.screen.width - 50);
				let y = randomIntFromInterval(50, app.screen.height - 50);
				
				box.x = x;
				box.y = y;
			} while (spriteNearThings(box, BOX_DISTANCE_THRESHOLD));
			
			
			boxes.push(box);
			
			app.stage.addChild(box);
		}
	}
	
	function setupStoragotchi() {
		storagotchi = PIXI.Sprite.from('storagotchi-1');
		storagotchi.anchor.set(0.5, 1);//bottom center of sprite
		
		console.log("Initial storagotchi height/width: ", storagotchi.height, storagotchi.width);
		
		storagotchi.width = app.screen.width * SG_WIDTH_MOD;
		storagotchi.scale.y = storagotchi.scale.x;
		
		storagotchi.x = app.screen.width / 2;
		storagotchi.y = app.screen.height / 2;
		
		app.stage.addChild(storagotchi);
	}
	
	function animateStoragotchi(app, time, delta) {
		storagotchi.rotation += ((Math.random() < 0.5) ? -1 : 1) * 0.05 * delta;
	}

</script>

</body>
</html>