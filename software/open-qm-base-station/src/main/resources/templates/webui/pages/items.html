{#include webui/mainWebPageTemplate showNavbar=true showTitle=true title='Items' titleIcon='balance-scale' page='items'}
{@java.util.Map allowedUnitsMap}
{#pageContent}
<div class="row">
    <div class="col d-grid gap-2">
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addEditModal"
                onclick="setupAddEditForAdd();"><i class="fas fa-plus"></i> Add Item
        </button>
    </div>
    <div class="col d-grid gap-2">
        <button type="button" class="btn btn-info"><i class="fas fa-eye"></i> Item stats</button>
    </div>
</div>
<br/>
<div class="row">
    <div class="col accordion" id="searchAccordion">
        <div class="accordion-item">
            <h2 class="accordion-header" id="searchHeader">
                <button class="accordion-button {#if !showSearch}collapsed{/if}" type="button" data-bs-toggle="collapse"
                        data-bs-target="#searchCollapse" aria-expanded="{#if showSearch}true{#else}false{/if}"
                        aria-controls="searchCollapse">
                    Search Fields
                </button>
            </h2>
            <div id="searchCollapse" class="accordion-collapse collapse {#if showSearch}show{/if}"
                 aria-labelledby="searchHeader" data-bs-parent="#searchAccordion">
                <div class="accordion-body">
                    {#search/item/itemSearchForm id='mainStorageSearch'}
                    {/search/item/itemSearchForm}
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col table-responsive">
        <table class=" table table-bordered table-striped table-hover table-sm">
            {#search/item/itemSearchResults searchResults=searchResult actionType='full' searchFormId='mainStorageSearch' pagingCalculations=pagingCalculations}
            {/search/item/itemSearchResults}
        </table>
    </div>
</div>
{#inputs/units/unitOptionsHidden allowedUnitsMap=allowedUnitsMap}
{/inputs/units/unitOptionsHidden}
{#inputs/attInputHidden}
{/inputs/attInputHidden}
{#inputs/keywordInputHidden}
{/inputs/keywordInputHidden}
{#search/image/imageSelectFormInputHidden}
{/search/image/imageSelectFormInputHidden}
{/pageContent}
{#modals}
{#modal id='addEdit' large=true title='Item add/edit'}
<div id="addEditFormMessages"></div>
<form id="addEditItemForm">
    <input type="hidden" id="addEditFormMode" value="">
    <input type="hidden" id="addEditFormId" value="">
    <div class="mb-3 row">
        <label for="addEditNameInput" class="col-sm-2 col-form-label">Name</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="addEditNameInput" placeholder="Name" required>
        </div>
    </div>
    <div class="mb-3 row">
        <label for="addEditStoredTypeInput" class="col-sm-2 col-form-label">Stored Type</label>
        <div class="col-sm-10">
            <select class="form-select" id="addEditStoredTypeInput" data-current="AMOUNT" onchange="addEditStoredTypeInputChanged()">
                <option value="AMOUNT_SIMPLE" selected>Amount</option>
                <option value="AMOUNT_LIST">Amount List</option>
                <option value="TRACKED">Tracked</option>
            </select>
        </div>
    </div>
    <div class="mb-3 row" id="trackedItemIdentifierNameRow" style="display: none;">
        <label for="addEditIdentifyingAttInput" class="col-sm-2 col-form-label">Identifying Attribute</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="addEditIdentifyingAttInput" placeholder="Identifying Attribute" required>
        </div>
    </div>
    <div class="mb-3 row" id="unitNameRow">
        <label for="addEditUnitInput" class="col-sm-2 col-form-label">Unit</label>
        <div class="col-sm-10">
            <select class="form-select" id="addEditUnitInput" onchange="handleItemUnitChange();">
                {#inputs/units/unitOptionsGroups}
                {/inputs/units/unitOptionsGroups}
            </select>
        </div>
    </div>
    <div class="mb-3 row" id="pricePerUnitNameRow">
        <label for="addEditPricePerUnitInput" class="col-sm-2 col-form-label">Price Per Unit</label>
        <div class="col-sm-10">
            <div class="input-group">
                <span class="input-group-text" id="addon-wrapping">{currency.getSymbol()}</span>
                <input type="number" class="form-control" id="addEditPricePerUnitInput" placeholder="Price Per Unit" required>
            </div>
        </div>
    </div>
    <hr />
    <div class="mb-3 row">
        <div class="col-sm-2 col-form-label">Stored</div>
        <div class="col-sm-10">
            <div class="accordion mt-2" id="storedContainer">

            </div>
            <div class="col d-grid gap-2">
                <button type="button" class="btn btn-sm btn-success mt-2" data-bs-toggle="modal" data-bs-target="#storageSearchSelectModal">
                    <i class="fas fa-plus"></i> Add Associated Storage
                </button>
            </div>
        </div>
    </div>
    <hr />
    {#search/image/imageSelectFormInput}
    {/search/image/imageSelectFormInput}
    {#inputs/keywordInput}
    {/inputs/keywordInput}
    {#inputs/attInput}
    {/inputs/attInput}
</form>
{/modal}
{#modal id='storageBlockView' large=true title='Storage Block View'}
<div class="row">
    {#carousel id='storageBlockViewCarousel' carouselCss='col'}{/carousel}
    <div class="col">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Location in storage:</h5>
                <div id="storageBlockViewBreadcrumbContainer">
                </div>
            </div>
        </div>
        <div class="card" id="storageBlockViewLocationContainer">
            <div class="card-body">
                <h5 class="card-title">Location:</h5>
                <p class="card-text" id="storageBlockViewLocation"></p>
            </div>
        </div>
        <div class="card" id="storageBlockViewCapacityContainer">
            <div class="card-body">
                <h5 class="card-title">Capacities:</h5>
                <div id="storageBlockViewCapacity">
                </div>
            </div>
        </div>
    </div>
</div>
<hr />
<div class="row">
    {#objView/objKeywordsView id='viewKeywordsSection' classes='col'}{/objView/objKeywordsView}
    {#objView/objAttsView id='viewAttsSection' classes='col'}{/objView/objAttsView}
</div>
<div class="row">
    <div class="col">
        {#objView/objHistoryView containerId='storageBlockHistory'}{/objView/objHistoryView}
    </div>
</div>
{/modal}
{#search/storage/StorageSearchSelectModal otherModalId="addEditModal"}
{/search/storage/StorageSearchSelectModal}
{#search/image/imageSearchSelectModal otherModalId="addEditModal"}
{/search/image/imageSearchSelectModal}
{/modals}

{#scripts}
<script src="/res/js/search.js"></script>
<script src="/res/js/obj/objEdit.js"></script>
<script src="/res/js/obj/objView.js"></script>
<script src="/res/js/obj/media/imageSearchSelect.js"></script>
<script src="/res/js/obj/storageBlock/storageSearchSelect.js"></script>
<script src="/res/js/obj/units.js"></script>
<script src="/res/js/obj/getters.js"></script>
<script src="/res/js/obj/storageBlock/capacities.js"></script>
<script src="/res/js/carousel.js"></script>

<script src="/res/js/obj/storageBlock/storageBlockTree.js"></script>
{/scripts}
{#pageScript}
<script>
var keywordInputTemplate = $('#keywordInputTemplate');
var attInputTemplate = $('#attInputTemplate');
var imageInputTemplate = $('#imageInputTemplate');
var trackedItemIdentifierNameRow = $('#trackedItemIdentifierNameRow');
var unitNameRow = $('#unitNameRow');
var pricePerUnitNameRow = $('#pricePerUnitNameRow');
var addEditUnitInput = $('#addEditUnitInput');
var addEditPricePerUnitInput = $('#addEditPricePerUnitInput');
var addEditStoredTypeInput = $('#addEditStoredTypeInput');
var storedContainer = $('#storedContainer');
var compatibleUnitOptions = "";

function haveStored(){
    return storedContainer.children().length > 0;
}

function updateCompatibleUnits(){
    var curSelected = addEditUnitInput.val();
    
    doRestCall({
        url: "/api/info/unitCompatibility/" + curSelected,
        extraHeaders: { accept:"text/html" },
        done: function (data){
            compatibleUnitOptions = data;
            
            storedContainer.find(".unitInput").each(function (i, selectInput){
                var selectInputJq = $(selectInput);
                selectInputJq.html(compatibleUnitOptions);
                selectInputJq.change();
            });
        }
    });
}
updateCompatibleUnits();

function handleItemUnitChange(){
    if(haveStored() && !confirm("Doing this will reset all held units. Are you sure?")){
        //TODO:: handle changing back to old value
    } else {
        updateCompatibleUnits();
    }
}

function resetAddEditForm(){
}

function setupAddEditForAdd(){
    resetAddEditForm();
}

function setIdAttField(){
    storedContainer.html("");
    var value = addEditStoredTypeInput[0].value;
    addEditStoredTypeInput.attr('data-current', "AMOUNT_SIMPLE");
    if(value === "AMOUNT_SIMPLE" || value === "AMOUNT_LIST") {
        trackedItemIdentifierNameRow.hide();
        unitNameRow.show();
        pricePerUnitNameRow.show();
    } else if(value === "TRACKED"){
        unitNameRow.hide();
        pricePerUnitNameRow.hide();
        trackedItemIdentifierNameRow.show();
        addEditStoredTypeInput.attr('data-current', "TRACKED");
    }
}

function addEditStoredTypeInputChanged(){
    if(haveStored() && !confirm("Changing the type of storage will clear all stored entries.\nAre you sure?")){
        addEditStoredTypeInput.val(
            addEditStoredTypeInput.attr('data-current')
        );
        return;
    }
    setIdAttField();
}

function removeStored(clicked){
    if(!confirm("Are you sure? This can't be undone.")){
        return;
    }
    console.log("Removing.");
    $(clicked).parent().parent().parent().parent().remove();
}

function getCommonStoredFormElements(headerId) {
    return  '<div class="mb-3 ">\n'+
            '    <label class="form-label">Condition Percentage</label>\n' +
            '    <div class="input-group">\n'+
            '        <input type="number" max="100" min="0" class="form-control storedConditionPercentageInput" name="condition" ' + (headerId == null?'':'onchange="addEditUpdateStoredHeader($(this).parent(), \''+headerId+'\')"')+'>\n'+ //TODO:: better label of better to worse
            '        <span class="input-group-text" id="addon-wrapping">%</span>\n'+ //TODO:: better label of better to worse
            '    </div>\n'+
            '</div>\n' +
            '<div class="mb-3">\n'+
            '    <label class="form-label">Condition Details</label>\n' +
            '    <textarea class="form-control" name=""></textarea>\n'+
            '</div>\n' +
            '<div class="mb-3">\n'+
            '    <label class="form-label">Expires</label>\n' +
            '    <input type="date" class="form-control storedExpiredInput" name="expires" ' + (headerId == null?'':'onchange="addEditUpdateStoredHeader(this, \''+headerId+'\')"')+'>\n'+ //TODO:: enforce future date?
            //TODO:: note to leave blank if not applicable
            '</div>\n' +
            imageInputTemplate.html() +
            keywordInputTemplate.html() +
            attInputTemplate.html() +
            '<div class="mb-3 ">\n'+
            '    <button type="button" class="btn btn-danger" onclick="removeStored(this);">Remove Stored</button> '+
            '</div>\n'
            ;
}

function getAmountStoredFormElements(headerId) {
    return '<div class="input-group mt-2 mb-3">\n'+
           '     <input type="number" class="form-control amountStoredValueInput" placeholder="Value" value="0" min="0" required onchange="addEditUpdateStoredHeader(this, \''+headerId+'\')">\n'+
           '     <select class="form-select amountStoredUnitInput unitInput" onchange="addEditUpdateStoredHeader(this, \''+headerId+'\')">'+compatibleUnitOptions+'</select>\n'+ //TODO:: populate
           '</div>\n'+
            getCommonStoredFormElements(headerId);
}

function addEditUpdateStoredHeader(caller, headerId){
    var parentElem = $($(caller).parent().parent().get(0));
    var header = $("#"+headerId);
    
    header.find(".addEditAmountDisplay").text(parentElem.find(".amountStoredValueInput").get(0).value);//.dataset.symbol);
    header.find(".addEditUnitDisplay").text(parentElem.find(".amountStoredUnitInput").get(0).value.replaceAll("\"", ""));
    
    var storedPercInput = parentElem.find(".storedConditionPercentageInput").get(0);
    if(storedPercInput.value){
        header.find(".addEditConditionDisplayText").text(storedPercInput.value);
        header.find(".addEditConditionDisplay").show();
    } else {
        header.find(".addEditConditionDisplay").hide();
    }
    
    var storedExpInput = parentElem.find(".storedExpiredInput").get(0);
    if(storedExpInput.value){
        header.find(".addEditExpiresDisplayText").text(storedExpInput.value);
        header.find(".addEditExpiresDisplay").show();
    } else {
        header.find(".addEditExpiresDisplay").hide();
    }
    
}

var numAmountStoredClicked=0;
function addNewAmountStored(formContentId, accordionId){
    var id="addEditAmountStoredEntry-"+(numAmountStoredClicked++);
    var collapseId = id + "-collapse";
    
    var output = $(
            '<div class="accordion-item storedItem">\n'+
            '    <h2 class="accordion-header" id="'+id+'">\n'+
            '        <button class="accordion-button thinAccordion collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#'+collapseId+'" aria-expanded="false" aria-controls="'+collapseId+'">\n'+
            '          <span class="addEditAmountDisplay">0</span>\n' +
            '          <span class="addEditUnitDisplay"></span>&nbsp;&nbsp;\n'+
            '          <span class="addEditConditionDisplay">Condition: <span class="addEditConditionDisplayText"></span>%&nbsp;&nbsp;</span>\n'+
            '          <span class="addEditExpiresDisplay">Expires: <span class="addEditExpiresDisplayText"></span></span>\n'+ //TODO:: expires
            '        </button>\n'+
            '    </h2>\n'+
            '    <div id="'+collapseId+'" class="accordion-collapse collapse" aria-labelledby="'+id+'" data-bs-parent="#'+accordionId+'">\n'+
            '        <div class="accordion-body">\n'+
            '            ' + getAmountStoredFormElements(id) +
            '        </div>\n'+
            '    </div>\n'+
            '</div>'
    );
    
    $('#'+formContentId).append(output);
    addEditUpdateStoredHeader(output.find(".amountStoredUnitInput").get(0), id);
    updateStorageNumHeld(output);
    return output;
}
function addNewTrackedStored(formContentId, caller){
    alert('Adding tracked form listing');
}

function updateStorageNumHeld(caller){
    //TODO:: search for parent with class (not working)
    var parentAccord = $(caller).parent(".storedAccordion");
    
    parentAccord.find(".storageNumHeld").get(0).text(
            parentAccord.find(".storedItem").length
    );
}

function addStorageBlockAccord(blockName, blockId){
    var accordId = "addEditItemStorageAssoc-" + blockId;
    var existantAccord = storedContainer.find("#" + accordId);
    if(existantAccord.length){
        console.log("Already had association with storage block " + blockId);
        //TODO:: open block section instead of alerting
        alert("Storage block already present.");
        return null;
    }
    var accordHeaderId = accordId + "-header";
    var accordCollapseId = accordId + "-collapse";
    var accordBodyId = accordId + "-body";
    var accordFormContentId = accordId + "-formContent";
    var accordButtonWrapperId = accordId + "-formAddButtonWraper";
    
    var newStorage =
    $('   <div class="accordion-item storedAccordion" id="'+accordId+'">\n'+
      '        <h2 class="accordion-header" id="'+accordHeaderId+'">\n'+
      '            <button class="accordion-button thinAccordion collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#'+accordCollapseId+'" aria-expanded="false" aria-controls="'+accordCollapseId+'">\n'+
      '                <img class="accordion-thumb" src="/api/media/image/for/storageBlock/'+blockId+'" alt="'+blockName+' image">\n'+
      '                '+blockName+'\n'+
      '                &nbsp;(<span class="storageNumHeld">0</span>)\n'+
      '            </button>\n'+
      '        </h2>\n'+
      '        <div id="'+accordCollapseId+'" class="accordion-collapse collapse" aria-labelledby="'+accordHeaderId+'" data-bs-parent="#storedContainer">\n' +
      '            <div class="accordion-body" id="'+accordBodyId+'">\n'+
      '                <div id="'+accordFormContentId+'" class="accordion"></div>\n'+
      '                <div id="'+accordButtonWrapperId+'" class="col d-grid gap-2"></div>\n'+
      '            </div>\n'+
      '        </div>\n'+
      '    </div>\n'
    );
    storedContainer.append(newStorage);
    var newAccordBody = newStorage.find("#" + accordBodyId);
    
    switch (addEditStoredTypeInput[0].value){
        case "AMOUNT_LIST":
            console.log("Setting up storage for AMOUNT_LIST");
            
            newAccordBody.find("#"+accordButtonWrapperId).append($(
                '<button type="button" class="btn btn-sm btn-success mt-2" onclick="addNewAmountStored(\''+accordFormContentId+'\', \''+accordFormContentId+'\');">\n'+
                '    <i class="fas fa-plus"></i> Add\n'+
                '</button>'
            ));
            break;
        case "TRACKED":
            console.log("Setting up storage for TRACKED");
            newAccordBody.find("#"+accordButtonWrapperId).append($(
                    '<div class="input-group mt-2">\n'+
                    '    <input type="text" class="form-control identifierValueInput" placeholder="Identifier Value">\n'+
                    '    <button class="btn btn-outline-success" type="button"  onclick="addNewTrackedStored(\''+accordFormContentId+'\', this);">' +
                    '        <i class="fas fa-plus"></i> Add\n'+
                    '    </button>\n'+
                    '</div>'
            ));
            break;
    }
    
    return newAccordBody;
}

function selectStorageBlock(blockName, blockId, inputIdPrepend, otherModalId){
    console.log("Selected " + blockId + " - " + blockName);
    var newStorageBody = addStorageBlockAccord(blockName, blockId);
    
    
}
</script>
{/pageScript}
{/include}