{#include webui/mainWebPageTemplate navbar="full" showTitle=true title='Items' page='items'}
{@java.util.Map allowedUnitsMap}
{#styleSheets}
    <link rel="stylesheet" href="/lib/Croppie-2.6.4/croppie.css"/>
{/styleSheets}
{#pageContent}
<div class="row">
    <div class="col d-grid gap-2">
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addEditModal"
                onclick="setupAddEditForAdd();">{#icons/add}{/icons/add} Add Item
        </button>
    </div>
    <div class="col d-grid gap-2">
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addItemFromFileModal">{#icons/addFile}{/icons/addFile} Add Item(s) from file
        </button>
    </div>
    <div class="col d-grid gap-2">
        <button type="button" class="btn btn-info">{#icons/view}{/icons/view} Item stats</button>
    </div>
</div>
<br/>
<div class="row">
    <div class="col accordion" id="searchAccordion">
        <div class="accordion-item">
            <h2 class="accordion-header" id="searchHeader">
                <button class="accordion-button {#if !showSearch}collapsed{/if}" type="button" data-bs-toggle="collapse"
                        data-bs-target="#searchCollapse" aria-expanded="{#if showSearch}true{#else}false{/if}"
                        aria-controls="searchCollapse">
                    Search Fields
                </button>
            </h2>
            <div id="searchCollapse" class="accordion-collapse collapse {#if showSearch}show{/if}"
                 aria-labelledby="searchHeader" data-bs-parent="#searchAccordion">
                <div class="accordion-body">
                    {#search/item/itemSearchForm id='mainStorageSearch'}
                    {/search/item/itemSearchForm}
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col table-responsive">
        <table class=" table table-bordered table-striped table-hover table-sm">
            {#search/item/itemSearchResults searchResults=searchResult actionType='full' searchFormId='mainStorageSearch' pagingCalculations=pagingCalculations}
            {/search/item/itemSearchResults}
        </table>
    </div>
</div>
{#inputs/units/unitOptionsHidden allowedUnitsMap=allowedUnitsMap}
{/inputs/units/unitOptionsHidden}
{#inputs/attInputHidden}
{/inputs/attInputHidden}
{#inputs/keywordInputHidden}
{/inputs/keywordInputHidden}
{#search/image/imageSelectFormInputHidden}
{/search/image/imageSelectFormInputHidden}
{/pageContent}
{#modals}
{#modal id='addEdit' large=true title='Item add/edit' submitForm='addEditItemForm' submitDismiss=false}
    
    <div class="row">
        <div class="col">
            <button type="button" class="btn btn-primary mb-1" onclick="toggleAddEditProductSearchPane();" title="Search for Products">
                {#icons/search}{/icons/search} Search for Products
            </button>
        </div>
    </div>
    <div class="row">
        <div class="col-6 card p-0" id="addEditProductSearchPane">
            <div class="card-header">
                Search for items:
            </div>
            <div class="card-body p-0 h-auto">
                <ul class="nav nav-tabs" id="extItemSearchTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="home" aria-selected="true">Product</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="false">Lego&trade;</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact" type="button" role="tab" aria-controls="contact" aria-selected="false">Website</button>
                    </li>
                </ul>
                <div class="tab-content p-1" id="searchTabContent">
                    <div class="tab-pane fade" id="home" role="tabpanel" aria-labelledby="home-tab">
                        <form id="prodBarcodeSearchForm">
                            <div class="mb-3">
                                <label for="prodBarcodeSearchBarcodeInput" class="form-label">Search with Barcode</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="prodBarcodeSearchBarcodeInput" aria-describedby="barcodeInputHelp" required>
                                    <button class="btn btn-success" type="submit">Search</button>
                                </div>
                                <div id="barcodeInputHelp" class="form-text">Scan in or enter a barcode on a product.</div>
                            </div>
                        </form>
                    </div>
                    <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                        <form id="legoPartNumSearchForm">
                            <div class="mb-3">
                                <label for="legoPartNumSearchInput" class="form-label">Search with Lego&trade; part number</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="legoPartNumSearchInput" aria-describedby="legoPartNumInputHelp" required>
                                    <button class="btn btn-success" type="submit">Search</button>
                                </div>
                                <div id="legoPartNumInputHelp" class="form-text">Most legos have a number on them, it's that parts numbers.</div>
                            </div>
                        </form>
                    </div>
                    <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">
                        <form id="websiteScanSearchForm">
                            <div class="mb-3">
                                <label for="websiteScanSearchInput" class="form-label">Scan a website</label>
                                <div class="input-group">
                                    <input type="url" class="form-control" id="websiteScanSearchInput" aria-describedby="websiteScanInputHelp" required>
                                    <button class="btn btn-success" type="submit">Search</button>
                                </div>
                                <div id="websiteScanInputHelp" class="form-text">Very limited number of supported sites.</div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="card-header">
                Search Results:
            </div>
            <div class="card-body h-100 row" id="extSearchResults">
            </div>
        </div>
        <div class="col">
            <div id="addEditFormMessages"></div>
            <form id="addEditItemForm">
                <input type="hidden" id="addEditFormMode" value="">
                <input type="hidden" id="addEditFormId" value="">
                <div class="mb-3 row">
                    <label for="addEditNameInput" class="col-sm-2 col-form-label">Name</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" id="addEditNameInput" placeholder="Name" required>
                    </div>
                </div>
                <div class="mb-3 row">
                    <label for="addEditDescriptionInput" class="col-sm-2 col-form-label">Description</label>
                    <div class="col-sm-10">
                        <textarea class="form-control" id="addEditDescriptionInput" placeholder="Description"></textarea>
                    </div>
                </div>
                <div class="mb-3 row">
                    <label for="addEditStorageTypeInput" class="col-sm-2 col-form-label">Stored Type</label>
                    <div class="col-sm-10">
                        <select class="form-select" id="addEditStorageTypeInput" data-current="AMOUNT_SIMPLE" onchange="addEditStoredTypeInputChanged()">
                            <option value="AMOUNT_SIMPLE" selected>Amount</option>
                            <option value="AMOUNT_LIST">Amount List</option>
                            <option value="TRACKED">Tracked</option>
                        </select>
                    </div>
                </div>
                <div class="mb-3 row" id="trackedItemIdentifierNameRow" style="display: none;">
                    <label for="addEditIdentifyingAttInput" class="col-sm-2 col-form-label">Identifying Attribute</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" id="addEditIdentifyingAttInput" placeholder="Identifying Attribute" required>
                    </div>
                </div>
                <!-- TODO:: default value -->
                <div class="mb-3 row" id="unitNameRow">
                    <label for="addEditUnitInput" class="col-sm-2 col-form-label">Unit</label>
                    <div class="col-sm-10">
                        <select class="form-select" id="addEditUnitInput" onchange="handleItemUnitChange();">
                            {#inputs/units/unitOptionsGroups}
                            {/inputs/units/unitOptionsGroups}
                        </select>
                    </div>
                </div>
                <div class="mb-3 row" id="pricePerUnitNameRow">
                    <label for="addEditPricePerUnitInput" class="col-sm-2 col-form-label">Price Per Unit</label>
                    <div class="col-sm-10">
                        <div class="input-group">
                            <span class="input-group-text" id="addon-wrapping">{currency.getSymbol()}</span>
                            <input type="number" min="0.00" step="any" class="form-control" id="addEditPricePerUnitInput" placeholder="Price Per Unit" required>
                        </div>
                    </div>
                </div>
                <div class="mb-3 row" id="pricePerUnitNameRow">
                    <label for="addEditExpiryWarningThresholdInput" class="col-sm-2 col-form-label">Expiry Warning Threshold</label>
                    <div class="col-sm-10">
                        <div class="input-group">
                            <input type="number" min="0" class="form-control" id="addEditExpiryWarningThresholdInput" placeholder="Expiry Warning Threshold" required value="0" aria-describedby="addEditExpiryWarningThresholdHelp">
                            <select class="form-select" style="max-width: 10em;" id="addEditExpiryWarningThresholdUnitInput">
                                <!-- The values here represent the multiplier to make the equivalent number of seconds for each -->
                                <option value="1">Seconds*</option>
                                <option value="60">Minutes*</option>
                                <option value="3600" selected>Hours</option>
                                <option value="86400">Days</option>
                                <option value="604800">Weeks</option>
                            </select>
                        </div>
                        <div id="addEditExpiryWarningThresholdHelp" class="form-text">
                            How many time units before expiration dates to warn of imminent expiration. 0 for no warning.<br />
                            * = Depending on server settings, you might not get an accurate warning with a short warning period.
                        </div>
                    </div>
                </div>
                <div class="mb-3 row">
                    <label for="addEditTotalLowStockThresholdInput" class="col-sm-2 col-form-label">Total Low Stock Threshold</label>
                    <div class="col-sm-10">
                        <div class="input-group mt-2 mb-3">
                            <input type="number" class="form-control amountStoredValueInput" id="addEditTotalLowStockThresholdInput" placeholder="Value" min="0.00" step="any">
                            <select class="form-select amountStoredUnitInput unitInput" id="addEditTotalLowStockThresholdUnitInput">
                            </select>
                        </div>
                        <div id="addEditTotalLowStockThresholdHelp" class="form-text">
                            The lowest amount to be stored before being marked as low on stock. Leave blank for no threshold.<br />
                            Unit taken from the item's unit.
                        </div>
                    </div>
                </div>
                <hr />
                <div class="mb-3 row">
                    <div class="col-sm-2 col-form-label">Stored</div>
                    <div class="col-sm-10">
                        <div class="accordion mt-2" id="storedContainer">
                
                        </div>
                        <div class="col d-grid gap-2 mt-3">
                            <button type="button" class="btn btn-sm btn-success mt-2" data-bs-toggle="modal" data-bs-target="#storageSearchSelectModal" onclick="storageSearchSelectForm.submit();">
                                {#icons/add}{/icons/add} Add Associated Storage
                            </button>
                        </div>
                    </div>
                </div>
                <hr />
                {#search/image/imageSelectFormInput}
                {/search/image/imageSelectFormInput}
                {#inputs/keywordInput}
                {/inputs/keywordInput}
                {#inputs/attInput}
                {/inputs/attInput}
            </form>
        </div>
    </div>

{/modal}
{#modal id='itemView' large=true title='Item View'}
    <div class="row">
        <div class="col" id="itemViewMessages">
			
		</div>
    </div>
<div class="row">
    {#carousel id='itemViewCarousel' carouselCss='col'}{/carousel}
    <div class="col">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title" style="display: inline">Id:</h5>
                <p class="card-text" style="display: inline"><span id="itemViewId"></span>{#copyTextButton textContainerId='itemViewId'}{/copyTextButton}</p>
            </div>
        </div>
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Storage Type:</h5>
                <div id="itemViewStorageType">
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Description:</h5>
                <div id="itemViewDescription">
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Total Held:</h5>
                <div id="itemViewTotal">
                </div>
            </div>
        </div>
        <div class="card" id="itemViewTotalLowStockThresholdContainer">
            <div class="card-body">
                <h5 class="card-title">Total Low Stock Threshold:</h5>
                <div id="itemViewTotalLowStockThreshold">
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Value per Unit <span id="itemViewValPerUnitDefault">(default)</span>:</h5>
                <div>
                    {currency.getSymbol()}<span id="itemViewValPerUnit"></span>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Total Value:</h5>
                <div>
                    {currency.getSymbol()}<span id="itemViewTotalVal"></span>
                </div>
            </div>
        </div>
        <div class="card" id="itemViewIdentifyingAttContainer">
            <div class="card-body">
                <h5 class="card-title">Identifying Attribute:</h5>
                <div id="itemViewIdentifyingAtt">
                </div>
            </div>
        </div>
        <!-- TODO:: add expiry warning duration -->
    </div>
</div>
<hr />
<div class="row">
    <div class="col">
        <div id="itemViewStoredNonePresentContainer">
            <h4>Nothing Stored</h4>
        </div>
        <div id="itemViewStored">
            <h4>Using <span id="itemViewStoredNum"></span> storage blocks:</h4>
            <div class="col accordion" id="itemViewStoredAccordion">
            </div>
        </div>
    </div>
</div>
<hr />
<div class="row">
    {#objView/objKeywordsView id='viewKeywordsSection' classes='col'}{/objView/objKeywordsView}
    {#objView/objAttsView id='viewAttsSection' classes='col'}{/objView/objAttsView}
</div>
<div class="row">
    <div class="col">
        {#objView/objHistoryView containerId='itemHistory'}{/objView/objHistoryView}
    </div>
</div>
{/modal}
{#modal id='addItemFromFile' large=true title='Add item(s) from file' submitForm='addItemFromFileForm' submitDismiss=false}
    <div class="row">
        <div class="col" id="addItemFromFileFormMessages">
        </div>
    </div>
    <!-- TODO:: point to docs on how to do this -->
    <div class="row">
        <div class="col">
            <form id="addItemFromFileForm">
                <div class="col-12 mb-3">
                    <label for="importBulkFileInput" class="form-label">CSV, or JSON file:</label>
                    <input class="form-control" type="file" id="addFromFileInput" name="file" accept="text/csv,application/json" required>
                </div>
            </form>
        </div>
    </div>
{/modal}
{#search/storage/StorageSearchSelectModal otherModalId="addEditModal"}
{/search/storage/StorageSearchSelectModal}
{#search/image/imageSearchSelectModal otherModalId="addEditModal"}
{/search/image/imageSearchSelectModal}
    {#inputs/item/itemAddSubTransModal otherModalId=""}
    {/inputs/item/itemAddSubTransModal}
{/modals}

{#scripts}
    <script src="/lib/Croppie-2.6.4/croppie.min.js"></script>
    <script src="/res/js/obj/media/imageAdd.js"></script>
    <script src="/res/js/obj/media/imageAddFromSelect.js"></script>
<script src="/res/js/search.js"></script>
<script src="/res/js/obj/objEdit.js"></script>
<script src="/res/js/obj/objView.js"></script>
<script src="/res/js/obj/media/imageSearchSelect.js"></script>
<script src="/res/js/obj/storageBlock/storageSearchSelect.js"></script>
<script src="/res/js/obj/units.js"></script>
<script src="/res/js/obj/getters.js"></script>
<script src="/res/js/obj/storageBlock/capacities.js"></script>
<script src="/res/js/carousel.js"></script>

<script src="/res/js/item/ItemEditing.js"></script>
<script src="/res/js/item/ItemAddSubTrans.js"></script>
<script src="/res/js/obj/storageBlock/storageBlockTree.js"></script>
    <script src="/res/js/textCopy.js"></script>
{/scripts}
{#pageScript}
<script>
const STORAGE_CLASS = "storageBlock";


var extSearchResults=$("#extSearchResults");
function handleExtItemSearchResults(results){
    console.log("Got Results! # results: " + results.results.length + "  # errors: " + Object.keys(results.serviceErrs).length)
    
    if(results.results.length === 0){
        extSearchResults.html("<p>No Results!</p>");
    }
    results.results.forEach(function(result){
        //TODO:: better formatting, handle many results well
        let resultCard = $('<div class="card col-6 p-0"></div>');
        
        resultCard.append($('<div class="card-header">'+result.source+'</div>'));
        resultCard.append($('<div class="card-body">Name: '+result.unifiedName+'</div>'));
    
        if(result.brand){
            '<div class="card-body">Brand: '+result.brand+'</div>'
        }
        if(result.description){
            '<div class="card-body">Description: '+result.description+'</div>'
        }
        
        extSearchResults.append(resultCard);
    });
}

var prodBarcodeSearchBarcodeInput = $("#prodBarcodeSearchBarcodeInput");
$("#prodBarcodeSearchForm").submit(function(event){
    event.preventDefault();
    let barcodeText = prodBarcodeSearchBarcodeInput.val();
    console.log("Searching for a barcode: " + barcodeText);
    extSearchResults.html("");
    
    doRestCall({
        url: "/api/v1/externalItemLookup/product/barcode/" + barcodeText,
        done: handleExtItemSearchResults
    });
});

var legoPartNumSearchInput = $("#legoPartNumSearchInput");
$("#legoPartNumSearchForm").submit(function(event){
    event.preventDefault();
    let partNumber = legoPartNumSearchInput.val();
    console.log("Searching for a lego part: " + partNumber);
    extSearchResults.html("");
    
    doRestCall({
        url: "/api/v1/externalItemLookup/lego/part/" + partNumber,
        done: handleExtItemSearchResults
    });
});

var websiteScanSearchInput = $("#websiteScanSearchInput");
$("#websiteScanSearchForm").submit(function(event){
    event.preventDefault();
    let webpage = websiteScanSearchInput.val();
    console.log("Scanning a web page: " + webpage);
    extSearchResults.html("");
    
    doRestCall({
        url: "/api/v1/externalItemLookup/webpage/scrape/" + encodeURIComponent(webpage),
        done: handleExtItemSearchResults
    });
});

var addEditProductSearchPane = $("#addEditProductSearchPane");
function toggleAddEditProductSearchPane(){
    addEditProductSearchPane.toggle();
}
function hideAddEditProductSearchPane(){
    addEditProductSearchPane.hide();
}
function showAddEditProductSearchPane(){
    addEditProductSearchPane.show();
}


var keywordInputTemplate = $('#keywordInputTemplate');
var attInputTemplate = $('#attInputTemplate');
var imageInputTemplate = $('#imageInputTemplate');

var addEditModal = $("#addEditModal");
var addEditFormId = $("#addEditFormId");
var addEditFormMessages = $("#addEditFormMessages");
var addEditModalLabel = $('#addEditModalLabel');
var addEditFormMode = $('#addEditFormMode');
var addEditItemForm = $('#addEditItemForm');
var addEditKeywordDiv = addEditItemForm.find(".keywordInputDiv");
var addEditAttDiv = addEditItemForm.find(".attInputDiv");
var addEditNameInput = $('#addEditNameInput');
var addEditDescriptionInput = $('#addEditDescriptionInput');
var addEditPricePerUnitInput = $('#addEditPricePerUnitInput');
var addEditExpiryWarningThresholdInput = $('#addEditExpiryWarningThresholdInput');
var addEditExpiryWarningThresholdUnitInput = $('#addEditExpiryWarningThresholdUnitInput');
var addEditTotalLowStockThresholdInput = $("#addEditTotalLowStockThresholdInput");
var addEditTotalLowStockThresholdUnitInput = $("#addEditTotalLowStockThresholdUnitInput");
var addEditStorageTypeInput = $('#addEditStorageTypeInput');
var addEditUnitInput = $('#addEditUnitInput');
var addEditIdentifyingAttInput = $('#addEditIdentifyingAttInput');
var addEditImagesSelected = addEditItemForm.find(".imagesSelected");

var storedContainer = $('#storedContainer');
var trackedItemIdentifierNameRow = $('#trackedItemIdentifierNameRow');
var unitNameRow = $('#unitNameRow');
var pricePerUnitNameRow = $('#pricePerUnitNameRow');
var compatibleUnitOptions = "";


function foreachStoredType(
        storedType,
        whenAmountSimple,
        whenAmountList,
        whenTracked
){
    if(storedType === "AMOUNT_SIMPLE"){
        if(whenAmountSimple !== null) {
            whenAmountSimple();
        }
    } else if(storedType === "AMOUNT_LIST"){
        if(whenAmountList !== null) {
            whenAmountList();
        }
    } else if(storedType === "TRACKED"){
        if(whenTracked !== null) {
            whenTracked();
        }
    }
}

function foreachStoredTypeFromAddEditInput(
        whenAmountSimple,
        whenAmountList,
        whenTracked
){
    foreachStoredType(
            addEditStorageTypeInput[0].value,
            whenAmountSimple,
            whenAmountList,
            whenTracked
    );
}

function haveStored(){
    return storedContainer.children().length > 0;
}


updateCompatibleUnits(addEditUnitInput.val(), addEditItemForm);

function handleItemUnitChange(){
    if(haveStored() && !confirm("Doing this will reset all held units. Are you sure?")){
        //TODO:: handle changing back to old value
    } else {
        updateCompatibleUnits(addEditUnitInput.val(), addEditItemForm);
    }
}

function resetAddEditForm(){
    hideAddEditProductSearchPane();
    addEditNameInput.val("");
    addEditDescriptionInput.val("");
    addEditModalLabel.text("Item");
    addEditPricePerUnitInput.val("0.00");
    addEditExpiryWarningThresholdInput.val(0);
    addEditExpiryWarningThresholdUnitInput.prop('selectedIndex',2);
    addEditTotalLowStockThresholdInput.val("");
    addEditIdentifyingAttInput.val("");
    addEditStorageTypeInput.prop( "disabled", false );
    addEditStorageTypeInput.val($("#addEditStorageTypeInput option:first").val());
    addEditUnitInput.val($("#addEditUnitInput option:first").val());
    
    setIdAttField();
    updateCompatibleUnits(addEditUnitInput.val(), storedContainer);
    
    addEditImagesSelected.text("");
    addEditKeywordDiv.text("");
    addEditAttDiv.text("");
}

function setupAddEditForAdd(){
    console.log("Setting up add/edit form for add.");
    resetAddEditForm();
    addEditModalLabel.text("Item Add");
    addEditFormMode.val("add");
}

function setStoredItemVales(storedDivJq, storedData){
    let forAmount = function(){
        storedDivJq.find("[name=amountStored]")[0].value = storedData.amount.value;
        storedDivJq.find("[name=amountStoredUnit]")[0].value = storedData.amount.unit.string;
    };
    foreachStoredTypeFromAddEditInput(
            forAmount,
            forAmount,
            function(){
                storedDivJq.find("[name=identifyingDetails]")[0].value = storedData.identifyingDetails;
    
            }
    );
    
    storedDivJq.find("[name=condition]")[0].value = storedData.condition;
    storedDivJq.find("[name=conditionDetails]")[0].value = storedData.conditionNotes;
    storedDivJq.find("[name=expires]")[0].value = storedData.expires;
    
    addSelectedImages(storedDivJq.find(".imagesSelected"), storedData.imageIds);
    addKeywordInputs(storedDivJq.find(".keywordInputDiv"), storedData.keywords);
    addAttInputs(storedDivJq.find(".attInputDiv"), storedData.attributes);
}

function setupAddEditForEdit(itemId){
    console.log("Setting up add/edit form for editing item " + itemId);
    resetAddEditForm();
    addEditModalLabel.text("Item Edit");
    addEditFormMode.val("edit");
    addEditStorageTypeInput.prop( "disabled", true );
    
    doRestCall({
        spinnerContainer: addEditModal,
        url: "/api/v1/inventory/item/" + itemId,
        failMessagesDiv: addEditFormMessages,
        done: async function(data){
            addSelectedImages(addEditImagesSelected, data.imageIds);
            addKeywordInputs(addEditKeywordDiv, data.keywords);
            addAttInputs(addEditAttDiv, data.attributes);
    
            addEditFormId.val(data.id);
            addEditNameInput.val(data.name);
            addEditDescriptionInput.val(data.description);
            addEditStorageTypeInput.val(data.storageType);
            addEditStoredTypeInputChanged();
            
            if(data.lowStockThreshold) {
                addEditTotalLowStockThresholdInput.val(data.lowStockThreshold.value)
                addEditTotalLowStockThresholdUnitInput.val(data.lowStockThreshold.unit.string)
            }
    
            let setAmountStoredVars = async function(){
                addEditUnitInput.val(data.unit.string);
                addEditPricePerUnitInput.val(data.valuePerUnit);
                await updateCompatibleUnits(addEditUnitInput.val(), storedContainer);
            };
    
            foreachStoredTypeFromAddEditInput(
                    await setAmountStoredVars,
                    await setAmountStoredVars,
                    function(){
                        addEditIdentifyingAttInput.val(data.trackedItemIdentifierName);
                    }
            );
            
            if((data.expiryWarningThreshold / 604800) % 1 == 0){
                console.log("Determined was weeks.");
                addEditExpiryWarningThresholdInput.val(data.expiryWarningThreshold / 604800);
                addEditExpiryWarningThresholdUnitInput.prop('selectedIndex', 4);
            } else if((data.expiryWarningThreshold / 86400) % 1 == 0){
                console.log("Determined was days.");
                addEditExpiryWarningThresholdInput.val(data.expiryWarningThreshold / 86400);
                addEditExpiryWarningThresholdUnitInput.prop('selectedIndex', 3);
            } else if((data.expiryWarningThreshold / 3600) % 1 == 0){
                console.log("Determined was hours.");
                addEditExpiryWarningThresholdInput.val(data.expiryWarningThreshold / 3600);
                addEditExpiryWarningThresholdUnitInput.prop('selectedIndex', 2);
            } else if((data.expiryWarningThreshold / 60) % 1 == 0){
                console.log("Determined was minutes.");
                addEditExpiryWarningThresholdInput.val(data.expiryWarningThreshold / 60);
                addEditExpiryWarningThresholdUnitInput.prop('selectedIndex', 1);
            } else {
                console.log("Determined was seconds.");
                addEditExpiryWarningThresholdInput.val(data.expiryWarningThreshold);
                addEditExpiryWarningThresholdUnitInput.prop('selectedIndex', 0);
            }
    
    
            Object.keys(data.storageMap).forEach(curStorageBlockId => {
                let newStorageBody = createStorageBlockAccord("", curStorageBlockId);
                
                let storageBlockEntriesContainer = newStorageBody.find(".storageBlockEntriesContainer");
                
                foreachStoredTypeFromAddEditInput(
                        function(){
                            setStoredItemVales(newStorageBody, data.storageMap[curStorageBlockId].stored);
                        },
                        function (){
                            data.storageMap[curStorageBlockId].stored.forEach(function(curStorageBlock){
                                let curId = 'addEditItemStorageAssoc-'+curStorageBlockId+'-formContent';
                                let newAmtStored = createNewAmountStored(curId, curId, false);
    
                                setStoredItemVales(
                                        newAmtStored,
                                        curStorageBlock
                                );
                                storageBlockEntriesContainer.append(newAmtStored);
                            });
                        },
                        function(){
                            let addItemField = newStorageBody.find(".identifierValueInput")[0];
                            let addItemButton = newStorageBody.find(".addTrackedItemButton");
                            Object.keys(data.storageMap[curStorageBlockId].stored).forEach(curItemIdentifier => {
                                addItemField.value = curItemIdentifier;
                                let curId = 'addEditItemStorageAssoc-'+curStorageBlockId+'-formContent';
                                let trackedStored = createNewTrackedStored(curId, addItemButton, false);
                                
                                setStoredItemVales(
                                        trackedStored,
                                        data.storageMap[curStorageBlockId].stored[curItemIdentifier]
                                );
                                storageBlockEntriesContainer.append(trackedStored);
                            });
                            addItemField.value = "";
                        }
                );
                addStorageBlockAccord(newStorageBody);
    
                getStorageBlockLabel(curStorageBlockId, function (blockName){
                    newStorageBody.find(".storageBlockName").text(blockName);
                });
            });
        }
    });
    
}

function setIdAttField(){
    storedContainer.html("");
    let value = addEditStorageTypeInput[0].value;
    
    if(addEditStorageTypeInput.attr('data-current') == null){
        addEditStorageTypeInput.attr('data-current', "AMOUNT_SIMPLE");
    } else {
        addEditStorageTypeInput.attr('data-current', value);
    }
    
    
    let whenAmount = function (){
        trackedItemIdentifierNameRow.hide();
        addEditIdentifyingAttInput.prop('required', false);
        unitNameRow.show();
        addEditUnitInput.prop('required',true);
        pricePerUnitNameRow.show();
        addEditPricePerUnitInput.prop('required',true);
    }
    
    foreachStoredTypeFromAddEditInput(
            whenAmount,
            whenAmount,
            function(){
                unitNameRow.hide();
                pricePerUnitNameRow.hide();
                addEditPricePerUnitInput.prop('required',false);
                addEditUnitInput.prop('required',false);
                trackedItemIdentifierNameRow.show();
                addEditIdentifyingAttInput.prop('required', true);
                addEditStorageTypeInput.attr('data-current', "TRACKED");
            }
    );
}

function addEditStoredTypeInputChanged(){
    if(haveStored() && !confirm("Changing the type of storage will clear all stored entries.\nAre you sure?")){
        addEditStorageTypeInput.val(
            addEditStorageTypeInput.attr('data-current')
        );
        return;
    }
    setIdAttField();
}

function removeStored(toRemoveId){
    if(!confirm("Are you sure? This can't be undone.")){
        return;
    }
    console.log("Removing.");
    $(toRemoveId).remove();
}

function getCommonStoredFormElements(headerId, toRemoveId) {
    return  '<div class="mb-3 ">\n'+
            '    <label class="form-label">Condition Percentage</label>\n' +
            '    <div class="input-group">\n'+
            '        <input type="number" max="100" min="0" step="any" class="form-control storedConditionPercentageInput" name="condition" ' + (headerId == null?'':'onchange="addEditUpdateStoredHeader(\''+headerId+'\')"')+'>\n'+ //TODO:: better label of better to worse
            '        <span class="input-group-text" id="addon-wrapping">%</span>\n'+ //TODO:: better label of better to worse
            '    </div>\n'+
            '</div>\n' +
            '<div class="mb-3">\n'+
            '    <label class="form-label">Condition Details</label>\n' +
            '    <textarea class="form-control" name="conditionDetails"></textarea>\n'+
            '</div>\n' +
            '<div class="mb-3">\n'+
            '    <label class="form-label">Expires</label>\n' +
            '    <input type="date" class="form-control storedExpiredInput" name="expires" ' + (headerId == null?'':'onchange="addEditUpdateStoredHeader(\''+headerId+'\')"')+'>\n'+ //TODO:: enforce future date?
            //TODO:: note to leave blank if not applicable
            '</div>\n' +
            imageInputTemplate.html() +
            keywordInputTemplate.html() +
            attInputTemplate.html() +
            '<div class="mb-3 ">\n'+
            '    <button type="button" class="btn btn-danger" onclick="removeStored(\'#'+toRemoveId+'\');">{#icons/remove}{/icons/remove} Remove Stored</button> '+
            '</div>\n'
            ;
}

/**
 *
 * @param headerId
 * @param toRemoveId
 * @returns \{string}
 */
function getAmountStoredFormElements(headerId, toRemoveId) {
    return '<div class="input-group mt-2 mb-3">\n'+
            '     <input type="number" class="form-control amountStoredValueInput" name="amountStored" placeholder="Value" value="0.00" min="0.00" step="any" required onchange="addEditUpdateStoredHeader(\''+headerId+'\')">\n'+
            '     <select class="form-select amountStoredUnitInput unitInput" name="amountStoredUnit" onchange="addEditUpdateStoredHeader(\''+headerId+'\')">'+compatibleUnitOptions+'</select>\n'+ //TODO:: populate
            '</div>\n'+
            getCommonStoredFormElements(headerId, toRemoveId);
}

/**
 *
 * @param headerId
 * @param toRemoveId
 * @returns \{string}
 */
function getTrackedStoredFormElements(headerId, toRemoveId) {
    return '<div class="mb-3">\n'+
            '    <label class="form-label">Identifier:</label>\n' +
            '    <input class="form-control" type="text" name="identifier" onchange="addEditUpdateStoredHeader(\''+headerId+'\')" required>\n'+ // TODO:: populate
            '</div>\n' +
            '<div class="mb-3">\n'+
            '    <label class="form-label">Identifying Details</label>\n' +
            '    <textarea class="form-control" name="identifyingDetails"></textarea>\n'+
            '</div>\n' +
            getCommonStoredFormElements(headerId, toRemoveId);
}

function addEditUpdateStoredHeader(containerOrHeaderId){
    let parentElem;
    let header;
    if(typeof containerOrHeaderId === 'string' || containerOrHeaderId instanceof String){
        header = $("#"+containerOrHeaderId);
        parentElem = $(header.parent().get(0));
    } else {
        parentElem = containerOrHeaderId;
        header = parentElem.find(".accordion-header");
    }
    
    let headerAmountDisplay = header.find(".addEditAmountDisplay");
    let headerUnitDisplay = header.find(".addEditUnitDisplay");
    let conditionDisplay = header.find(".addEditConditionDisplay");
    let addEditExpiresDisplay = header.find(".addEditExpiresDisplay");
    
    let itemIdentifierDisplay = header.find(".itemIdentifierDisplay");
    
    if(headerAmountDisplay.length){
        headerAmountDisplay.text(parentElem.find(".amountStoredValueInput").get(0).value);//.dataset.symbol);
    }
    if(headerUnitDisplay.length) {
        headerUnitDisplay.text(parentElem.find(".amountStoredUnitInput").get(0).value.replaceAll("\"", ""));
    }
    
    if(conditionDisplay.length) {
        let storedPercInput = parentElem.find(".storedConditionPercentageInput").get(0);
        if (storedPercInput.value) {
            header.find(".addEditConditionDisplayText").text(storedPercInput.value);
            conditionDisplay.show();
        } else {
            conditionDisplay.hide();
        }
    }
    
    if(addEditExpiresDisplay.length) {
        let storedExpInput = parentElem.find(".storedExpiredInput").get(0);
        if (storedExpInput.value) {
            header.find(".addEditExpiresDisplayText").text(storedExpInput.value);
            addEditExpiresDisplay.show();
        } else {
            addEditExpiresDisplay.hide();
        }
    }
    
    if(itemIdentifierDisplay.length){
        let itemIdInput = parentElem.find("[name=identifier]");
        if(itemIdInput.length) {
            itemIdentifierDisplay.text(itemIdInput.get(0).value);
        }
    }
}

function addNewAmountStored(amountStored, formContentId){
    $('#'+formContentId).append(amountStored);
}

var numAmountStoredClicked=0;
function createNewAmountStored(formContentId, parentId, add=true){
    var id="addEditAmountStoredEntry-"+(numAmountStoredClicked++);
    var headerId=id+"-header";
    var collapseId = id + "-collapse";
    
    var output = $(
            '<div class="accordion-item storedItem" id="'+id+'">\n'+
            '    <h2 class="accordion-header" id="'+headerId+'">\n'+
            '        <button class="accordion-button thinAccordion collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#'+collapseId+'" aria-expanded="false" aria-controls="'+collapseId+'">\n'+
            '          <span class="addEditAmountDisplay">0</span>\n' +
            '          <span class="addEditUnitDisplay"></span>&nbsp;&nbsp;\n'+
            '          <span class="addEditConditionDisplay">Condition: <span class="addEditConditionDisplayText"></span>%&nbsp;&nbsp;</span>\n'+
            '          <span class="addEditExpiresDisplay">Expires: <span class="addEditExpiresDisplayText"></span></span>\n'+ //TODO:: expires
            '        </button>\n'+
            '    </h2>\n'+
            '    <div id="'+collapseId+'" class="accordion-collapse collapse storage-list-entry" aria-labelledby="'+id+'" data-bs-parent="#'+parentId+'">\n'+
            '        <div class="accordion-body storedContainer">\n'+
            '            ' + getAmountStoredFormElements(headerId, id) +
            '        </div>\n'+
            '    </div>\n'+
            '</div>'
    );
    
    if(add){
        addNewAmountStored(output, formContentId);
    }
    addEditUpdateStoredHeader(id);
    updateStorageNumHeld(output);
    return output;
}

function createNewTrackedStored(trackedStored, formContentId){
    $('#'+formContentId).append(trackedStored);
}



var numTrackedStoredClicked=0;
function createNewTrackedStored(formContentId, caller, add = true){
    console.log("Adding new tracked storage item");
    
    let trackedStoredIdInput = $(caller).parent().find('.identifierValueInput').get(0);
    let trackedId = trackedStoredIdInput.value.trim();
    
    if(trackedId.length === 0){
        console.warn("No user input for id.");
        return;
    }
    let exists = false;
    storedContainer.find("[name=identifier]").each(function(i){
        if(this.value.trim() === trackedId){
            exists = true;
        }
    });
    if(exists){
        console.warn("Id already exists.");
        alert("Identifier already exists");
        return;
    }
    
    trackedStoredIdInput.value = "";
    let id="addEditTrackedStoredEntry-"+(numTrackedStoredClicked++);
    let headerId=id+"-header";
    let collapseId = id + "-collapse";
    
    let output = $(
            '<div class="accordion-item storedItem" id="'+id+'">\n'+
            '    <h2 class="accordion-header" id="'+headerId+'">\n'+
            '        <button class="accordion-button thinAccordion collapsed itemIdentifierDisplay" type="button" data-bs-toggle="collapse" data-bs-target="#'+collapseId+'" aria-expanded="false" aria-controls="'+collapseId+'">\n'+
            '          ' + trackedId + '\n' +
            '        </button>\n'+
            '    </h2>\n'+
            '    <div id="'+collapseId+'" class="accordion-collapse collapse storage-list-entry" aria-labelledby="'+id+'" data-bs-parent="#'+formContentId+'">\n'+
            '        <div class="accordion-body storedContainer">\n'+
            '            ' + getTrackedStoredFormElements(headerId, id) +
            '        </div>\n'+
            '    </div>\n'+
            '</div>'
    );
    output.find("[name=identifier]").val(trackedId);
    
    addEditUpdateStoredHeader(id);
    updateStorageNumHeld(output);
    if(add) {
        $(caller).parent().parent().parent().find(".storageBlockEntriesContainer").append(output);
    }
    return output;
}

function updateStorageNumHeld(caller){
    //TODO:: search for parent with class (not working)
    // var parentAccord = $(caller).parent(".storedAccordion");
    //
    // parentAccord.find(".storageNumHeld").get(0).text(
    //         parentAccord.find(".storedItem").length
    // );
}

function addStorageBlockAccord(newBlockAccord){
    storedContainer.append(newBlockAccord);
}

function createStorageBlockAccord(blockName, blockId, add = true){
    let accordId = "addEditItemStorageAssoc-" + blockId;
    let existantAccord = storedContainer.find("#" + accordId);
    if(existantAccord.length){
        console.log("Already had association with storage block " + blockId);
        //TODO:: open block section instead of alerting
        alert("Storage block already present.");
        return null;
    }
    let accordHeaderId = accordId + "-header";
    let accordCollapseId = accordId + "-collapse";
    let accordBodyId = accordId + "-body";
    let accordFormContentId = accordId + "-formContent";
    let accordButtonWrapperId = accordId + "-formAddButtonWraper";
    
    let newStorage =
    $('   <div class="accordion-item storedAccordion" id="'+accordId+'">\n'+
      '        <h2 class="accordion-header" id="'+accordHeaderId+'">\n'+
      '            <button class="accordion-button thinAccordion collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#'+accordCollapseId+'" aria-expanded="false" aria-controls="'+accordCollapseId+'">\n'+
      '                <img class="accordion-thumb" src="/api/v1/media/image/for/storageBlock/'+blockId+'" alt="'+blockName+' image">\n'+
      '                <span class="storageBlockName">'+blockName+'</span>\n'+
      '                &nbsp;(<span class="storageNumHeld">0</span>)\n'+
      '            </button>\n'+
      '        </h2>\n'+
      '        <div id="'+accordCollapseId+'" class="accordion-collapse collapse" aria-labelledby="'+accordHeaderId+'" data-bs-parent="#storedContainer">\n' +
      '            <div class="accordion-body" id="'+accordBodyId+'">\n'+
      '                <div id="'+accordFormContentId+'" class="accordion '+STORAGE_CLASS+' storageBlockEntriesContainer" data-storageBlockId="'+blockId+'"></div>\n'+
      '                <div id="'+accordButtonWrapperId+'" class="col d-grid gap-2"></div>\n'+
      '            </div>\n'+
      '        </div>\n'+
      '    </div>\n'
    );
    
    let newAccordBody = newStorage.find("#" + accordBodyId);
    let accordBodyButtonWrapper = newAccordBody.find("#"+accordButtonWrapperId);
    let accordBodyFormContentWrapper = newAccordBody.find("#"+accordFormContentId);
    
    foreachStoredTypeFromAddEditInput(
            function(){
                console.log("Setting up storage for AMOUNT_SIMPLE");
    
                accordBodyFormContentWrapper.append($(
                        getAmountStoredFormElements(accordHeaderId, accordId)
                ));
            },
            function(){
                console.log("Setting up storage for AMOUNT_LIST");
    
                accordBodyButtonWrapper.append($(
                        '<button type="button" class="btn btn-sm btn-success mt-2 addAmountStoredButton" onclick="createNewAmountStored(\''+accordFormContentId+'\', \''+accordFormContentId+'\');">\n'+
                        '    {#icons/add}{/icons/add} Add\n'+
                        '</button>\n'+
                        '<button type="button" class="btn btn-sm btn-danger mt-2" onclick="if(confirm(\'Are you sure? This cannot be undone.\')){ $(\'#'+accordId+'\').remove();}">\n'+
                        '    {#icons/remove}{/icons/remove} Remove Associated Storage\n'+
                        '</button>'
                ));
            },
            function(){
                console.log("Setting up storage for TRACKED");
                accordBodyButtonWrapper.append($(
                        '<div class="input-group mt-2">\n'+
                        '    <input type="text" class="form-control identifierValueInput" placeholder="Identifier Value">\n'+
                        '    <button class="btn btn-outline-success addTrackedItemButton" type="button"  onclick="createNewTrackedStored(\''+accordFormContentId+'\', this);">' +
                        '        {#icons/add}{/icons/add} Add\n'+
                        '    </button>\n'+
                        '</div>'+
                        '<button type="button" class="btn btn-sm btn-danger mt-2" onclick="if(confirm(\'Are you sure? This cannot be undone.\')){ $(\'#'+accordId+'\').remove();}">\n'+
                        '    {#icons/remove}{/icons/remove} Remove Associated Storage\n'+
                        '</button>'
                ));
            }
    );
    
    if(add) {
        addStorageBlockAccord(newStorage);
    }
    return newStorage;
}

function selectStorageBlock(blockName, blockId, inputIdPrepend, otherModalId){
    console.log("Selected " + blockId + " - " + blockName);
    var newStorageBody = createStorageBlockAccord(blockName, blockId);
}

function buildStoredObj(storedContainer, type){
    let output = {
        storedType: type
    };
    
    //TODO:: check this func for completeness of diff types
    if( type == "TRACKED"){
        output['identifier'] = storedContainer.find("[name=identifier").val()
    }
    
    {
        let amountInput = storedContainer.find("[name=amountStored]");
        if (amountInput.length) {
            output["amount"] = getQuantityObj(
                    parseFloat(amountInput.get(0).value),
                    storedContainer.find("[name=amountStoredUnit]").get(0).value
            );
        }
    }
    
    {
        let input = storedContainer.find("[name=condition]");
        if (input.length) {
            parseFloat(output["condition"] = input.get(0).value);
        }
    }
    {
        let input = storedContainer.find("[name=conditionDetails]");
        if (input.length) {
            output["conditionNotes"] = input.get(0).value;
        }
    }
    {
        let input = storedContainer.find("[name=expires]");
        if (input.length) {
            output["expires"] = input.get(0).value;
        }
    }
    addKeywordAttData(output, $(storedContainer.find(".keywordInputDiv").get(0)), $(storedContainer.find(".attInputDiv").get(0)));
    addImagesToData(output, $(storedContainer.find(".imagesSelected").get(0)));
    
    
    return output;
}

function removeItem(itemId){
    if(!confirm("Are you sure you want to delete this item? This cannot be undone.")){
        return;
    }
    console.log("Removing item " + itemId);
    
    doRestCall({
        url: "/api/v1/inventory/item/" + itemId,
        method: "DELETE",
        done: function(data) {
            console.log("Response from remove request: " + JSON.stringify(data));
            reloadPageWithMessage("Removed item successfully!", "success", "Success!");
        },
        fail: function(data) {
            console.warn("Bad response from remove attempt: " + JSON.stringify(data));
            addMessageToDiv(addEditFormMessages, "danger", "Failed to remove item.", "Failed", null);
        }
    });
}

addEditItemForm.submit(async function (event) {
    event.preventDefault();
    console.log("Submitting add/edit form.");
    
    let addEditData = {
        name: addEditNameInput.val(),
        description: addEditDescriptionInput.val(),
        storageType: addEditStorageTypeInput.val(),
        expiryWarningThreshold: addEditExpiryWarningThresholdInput.val() * addEditExpiryWarningThresholdUnitInput.val(),
        lowStockThreshold: (addEditTotalLowStockThresholdInput.val() ? getQuantityObj(
                addEditTotalLowStockThresholdInput.val(),
                addEditTotalLowStockThresholdUnitInput.val()
        ) : null),
        storageMap: { }
    };
    
    let setAmountStoredVars = function () {
        addEditData["unit"] = {
            string: addEditUnitInput.val()
        };
        addEditData["valuePerUnit"] = addEditPricePerUnitInput.val();
    };
    
    foreachStoredTypeFromAddEditInput(
            setAmountStoredVars,
            setAmountStoredVars,
            function () {
                addEditData["trackedItemIdentifierName"] = addEditIdentifyingAttInput.val();
            }
    );
    
    addKeywordAttData(addEditData, addEditKeywordDiv, addEditAttDiv);
    addImagesToData(addEditData, addEditImagesSelected);
    
    storedContainer.find(".storageBlock").each(function (i, storageBlockElement) {
        let storageBlockElementJq = $(storageBlockElement);
        let curStorageId = storageBlockElementJq.attr('data-storageBlockId');
        let storedVal;
        
        foreachStoredTypeFromAddEditInput(
                function () {
                    storedVal = buildStoredObj(storageBlockElementJq, "AMOUNT");
                },
                function () {
                    storedVal = [];
                    storageBlockElementJq.find(".storage-list-entry").each(function (j, storedElement) {
                        storedVal.push(buildStoredObj($(storedElement), "AMOUNT"));
                    });
                },
                function () {
                    storedVal = {};
                    storageBlockElementJq.find(".storage-list-entry").each(function (j, storedElement) {
                        let elementJq = $(storedElement);
                        storedVal[elementJq.find("[name=identifier").val()] = buildStoredObj(elementJq, "TRACKED");
                    });
                }
        );
        
        storedVal = {
            stored: storedVal
        };
        
        addEditData.storageMap[curStorageId] = storedVal;
    });
    
    console.log("Data being submitted: " + JSON.stringify(addEditData));
    let verb = "";
    let result = false;
    if (addEditFormMode.val() === "add") {
        verb = "Created";
        console.log("Adding new item.");
        await doRestCall({
            url: "/api/v1/inventory/item",
            method: "POST",
            data: addEditData,
            async: false,
            done: function (data) {
                console.log("Response from create request: " + JSON.stringify(data));
                result = true;
            },
            failMessagesDiv: addEditFormMessages
        });
    } else if (addEditFormMode.val() === "edit") {
        verb = "Edited";
        let id = addEditFormId.val();
        console.log("Editing storage block " + id);
        
        await doRestCall({
            url: "/api/v1/inventory/item/" + id,
            method: "PUT",
            data: addEditData,
            async: false,
            done: function (data) {
                console.log("Response from create request: " + JSON.stringify(data));
                result = true;
            },
            failMessagesDiv: addEditFormMessages
        });
    }
    
    if (!result) {
        addMessageToDiv(addEditFormMessages, "danger", "Failed to do "+verb+" item.", "Failed", null);
    } else {
        reloadPageWithMessage(verb + " item successfully!", "success", "Success!");
    }
});

var itemViewModal = $("#itemViewModal");
var itemViewMessages = $("#itemViewMessages");
var itemViewModalLabel = $("#itemViewModalLabel");
var itemViewStoredContainer = $("#itemViewStoredContainer");
var itemViewStored = $("#itemViewStored");
var itemViewStoredNonePresentContainer = $("#itemViewStoredNonePresentContainer");
var itemViewStoredNum = $("#itemViewStoredNum");
var itemViewStoredAccordion = $("#itemViewStoredAccordion");
var itemViewTotalVal = $("#itemViewTotalVal");
var itemViewValPerUnitDefault = $("#itemViewValPerUnitDefault");
var itemViewValPerUnit = $("#itemViewValPerUnit");

var itemViewCarousel = $("#itemViewCarousel");
var itemViewStorageType = $("#itemViewStorageType");
var itemViewDescription = $("#itemViewDescription");
var itemViewTotal = $("#itemViewTotal");
var itemViewTotalLowStockThresholdContainer = $("#itemViewTotalLowStockThresholdContainer");
var itemViewTotalLowStockThreshold = $("#itemViewTotalLowStockThreshold");
var itemViewIdentifyingAttContainer = $("#itemViewIdentifyingAttContainer");
var itemViewIdentifyingAtt = $("#itemViewIdentifyingAtt");

var viewKeywordsSection = $("#viewKeywordsSection");
var viewAttsSection = $("#viewAttsSection");
var itemHistory = $("#itemHistory");
var itemViewId = $("#itemViewId");

function resetView(){
    itemViewStoredContainer.text("");
    itemViewModalLabel.text("");
    itemViewStoredNum.text("");
    itemViewStored.hide();
    itemViewStoredNonePresentContainer.hide();
    itemViewStoredAccordion.text("");
    itemViewValPerUnitDefault.hide();
    itemViewValPerUnit.text("");
    itemViewIdentifyingAttContainer.hide();
    itemViewTotalVal.text("");
    
    itemViewIdentifyingAtt.text("");
    
    itemViewStorageType.text("");
    itemViewDescription.text("");
    itemViewTotal.text("");
    itemViewTotalLowStockThreshold.text("");
    itemViewTotalLowStockThresholdContainer.hide();
    
    itemHistory.text('');
    clearCarousel(itemViewCarousel);
    clearHideKeywordDisplay(viewKeywordsSection);
    clearHideAttDisplay(viewAttsSection);
}

function addViewAccordionItem(id, content, headerContent, trackedType){
    let accordId = "itemViewAccordBlock" + id;
    
    //if not string, expected as stored obj
    if (typeof headerContent !== 'string' && !(headerContent instanceof String)){
        let stored = headerContent;
        headerContent = "";
        
        let funcForAmount = function (){
            headerContent += stored.amount.value + stored.amount.unit.symbol;
        };
        foreachStoredType(
                trackedType,
                funcForAmount,
                funcForAmount,
                function (){
                
                }
        );
    
        if(stored.condition){
            headerContent += " Condition: " + stored.condition + "%";
        }
        if(stored.expires){
            headerContent += " Expires: " + stored.expires;
        }
    }
    
    return '<div class="accordion-item">'+
            '<h2 class="accordion-header" id="'+accordId+'Header">'+
                '<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#'+accordId+'Collapse" aria-expanded="false" aria-controls="'+accordId+'Collapse">'+
            headerContent+
    '</button>'+
'</h2>'+
    '<div id="'+accordId+'Collapse" class="accordion-collapse collapse" aria-labelledby="'+accordId+'Header" data-bs-parent="#'+accordId+'Header">'+
        '<div class="accordion-body">'+
            content +
        '</div>'+
    '</div>'+
'</div>';
}

function addViewStorageBlocksAccordionItem(blockId, content, stored){
    return itemViewStoredAccordion.append($(addViewAccordionItem(blockId, content, stored)));
}

function getBlockViewCell(name, value){
    return '<div class="col"><h5>'+name+':</h5><p>'+ value +'</p></div>';
}

function getStorageBlockAmountHeldView(stored, storedType){
    if(storedType.includes("AMOUNT")) {
        return getBlockViewCell("Stored", stored.amount.value + stored.amount.unit.symbol);
    }
    return "";
}
function getStorageBlockIdentifyingDetailsView(stored, storedType){
    if(storedType.includes("TRACKED") && stored.identifyingDetails) {
        return getBlockViewCell("Identifying Details", stored.identifyingDetails);
    }
    return "";
}

function getStorageBlockConditionView(stored){
    if(stored.condition) {
        return getBlockViewCell("Condition", stored.condition + "%");
    }
    return "";
}
function getStorageBlockConditionNotesView(stored){
    if(stored.conditionNotes) {
        return getBlockViewCell("Condition Notes", stored.conditionNotes);
    }
    return "";
}
function getStorageBlockExpiresView(stored){
    if(stored.expires) {
        return getBlockViewCell("Expires", stored.expires);
    }
    return "";
}

function getStoredViewContent(stored, storedType){
    return '<div class="row">' +
            getStorageBlockAmountHeldView(stored, storedType)+
            getStorageBlockIdentifyingDetailsView(stored, storedType)+
            getStorageBlockConditionView(stored)+
            getStorageBlockConditionNotesView(stored)+
            getStorageBlockExpiresView(stored)+
            '</div>';
    //TODO:: images, keywords, atts
}

function getAmountStoredContent(stored){
    console.log("Getting view content for simple amount stored.");
    return getStoredViewContent(stored, "AMOUNT_SIMPLE");
}

function getAmountListStoredContent(blockId, storedList){
    console.log("Getting view content for list amount stored.");
    
    
    let accordContent = "";
    
    if(storedList.length > 0) {
        let accordId = "itemViewStored"+blockId+"Accordion";
        let i = 0;
        storedList.forEach(function (curStored) {
            accordContent += addViewAccordionItem(
                    accordId + i,
                    getStoredViewContent(curStored, "AMOUNT_LIST"),
                    curStored,
                    "AMOUNT_LIST"
            );
            i++;
        });
        
        accordContent = '<div class="col accordion" id="'+accordId+'">'+
                accordContent +
                '</div>';
    } else {
        accordContent = '<div class="col"><h4>Nothing currently stored.</h4></div>'
    }
    
    return '<div class="row"> ' +
        accordContent +
    '</div>';
}

function getTrackedStoredContent(blockId, trackedMap){
    console.log("Getting view content for tracked stored.");
    
    let accordContent = "";
    let storageIds = Object.keys(trackedMap);
    
    if(storageIds.length > 0) {
        let accordId = "itemViewStored"+blockId+"Accordion";
        storageIds.forEach(key => {
            accordContent += addViewAccordionItem(
                    accordId + key,
                    getStoredViewContent(trackedMap[key], "TRACKED"),
                    key
            );
        });
        
        accordContent = '<div class="col accordion" id="'+accordId+'">'+
                accordContent +
                '</div>';
    } else {
        accordContent = '<div class="col"><h4>Nothing currently stored.</h4></div>'
    }
    
    return '<div class="row"> ' +
            accordContent +
            '</div>';
}

function setupView(itemId){
    console.log("Setting up view for item " + itemId);
    resetView();
    
    itemViewId.text(itemId);
    addOrReplaceParams("view", itemId);
    itemViewModalLabel.text(itemId);
    
    doRestCall({
        spinnerContainer: itemViewModal,
        url: "/api/v1/inventory/item/" + itemId,
        done: async function (data) {
            let promises = [];
            processKeywordDisplay(viewKeywordsSection, data.keywords);
            processAttDisplay(viewAttsSection, data.attributes);
            displayObjHistory(itemHistory, "/inventory/item/" + data.id);
            itemViewModalLabel.text(data.labelText);
            itemViewStorageType.text(data.storageType);
            itemViewDescription.text(data.description);
            itemViewTotal.text(data.total.value + "" + data.total.unit.symbol);
            itemViewTotalVal.text(data.valueOfStored);
            
            if(data.lowStockThreshold){
                itemViewTotalLowStockThreshold.text(data.lowStockThreshold.value + "" + data.lowStockThreshold.unit.symbol);
                itemViewTotalLowStockThresholdContainer.show();
            }
    
            if (data.imageIds.length) {
                console.log("Item had images to show.");
                itemViewCarousel.show();
                promises.push(setCarouselImagesFromIds(data.imageIds, itemViewCarousel));
            } else {
                console.log("Storage block had no images to show.");
                itemViewCarousel.hide();
            }
    
            console.log("Setting up view of stored.");
    
            let numStorageBlocks = Object.keys(data.storageMap).length;
    
            if (numStorageBlocks === 0) {
                console.log("None stored.");
                itemViewStoredNonePresentContainer.show();
            } else {
                console.log(numStorageBlocks + " stored.");
                itemViewStoredNum.text(numStorageBlocks);
                itemViewStored.show();
            }
    
            let showAmountStoredPricePerUnit = function () {
                itemViewValPerUnit.text(data.valuePerUnit);
            }
            foreachStoredType(
                    data.storageType,
                    showAmountStoredPricePerUnit,
                    showAmountStoredPricePerUnit,
                    function () {
                        itemViewValPerUnit.text(data.defaultValue);
                        itemViewValPerUnitDefault.show();
                
                        itemViewIdentifyingAtt.text(data.trackedItemIdentifierName);
                        itemViewIdentifyingAttContainer.show();
                    }
            );
    
            Object.keys(data.storageMap).forEach(key => {
                promises.push(new Promise( async function(){
                    console.log("Processing stored under storage block " + key);
                    let curBlockName = key;
                    await doRestCall({
                        spinnerContainer: null,
                        async: false,
                        url: "/api/v1/inventory/storage-block/" + key,
						failMessagesDiv: itemViewMessages,
                        done: function (data) {
                            curBlockName = data.label;
                        }
                    });
        
                    foreachStoredType(
                            data.storageType,
                            function () {
                                addViewStorageBlocksAccordionItem(
                                        key,
                                        getAmountStoredContent(data.storageMap[key].stored),
                                        curBlockName
                                );
                            },
                            function () {
                                addViewStorageBlocksAccordionItem(
                                        key,
                                        getAmountListStoredContent(key, data.storageMap[key].stored),
                                        curBlockName
                                );
                            },
                            function () {
                                addViewStorageBlocksAccordionItem(
                                        key,
                                        getTrackedStoredContent(key, data.storageMap[key].stored),
                                        curBlockName
                                );
                            }
                    );
                }));
            });
            await Promise.all(promises);
        },
        failMessagesDiv: itemViewMessages
    });
}

var viewModal = new bootstrap.Modal(itemViewModal, { });

itemViewModal[0].addEventListener("hidden.bs.modal", function (){
    removeParam("view");
});

if(getParams.has("view")){
    setupView(getParams.get("view"));
    viewModal.show();
}

var addFromFileInput = $("#addFromFileInput")[0];
var addItemFromFileFormMessages = $("#addItemFromFileFormMessages");

$("#addItemFromFileForm").submit(function (e){
    e.preventDefault();
    
    let formData = new FormData();
    let file = addFromFileInput.files[0];
    
    formData.append("fileName", file.name);
    formData.append("file", file);
    
    doRestCall({
        url: '/api/v1/inventory/item',
        method: "post",
        data: formData,
        done: function (data){
            console.log("Successfully added items.");
            reloadPageWithMessage("Added item(s) successfully!", "success", "Success!");
        },
        failMessagesDiv: addItemFromFileFormMessages
    });
});

</script>
{/pageScript}
{/include}