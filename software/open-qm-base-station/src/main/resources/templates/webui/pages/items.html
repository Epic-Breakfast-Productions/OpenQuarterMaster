{#include webui/mainWebPageTemplate navbar="full" showTitle=true title='Items' page='items'}
{@java.util.Map allowedUnitsMap}
{#styleSheets}
    <link rel="stylesheet" href="/lib/Croppie-2.6.4/croppie.css"/>
{/styleSheets}
{#pageContent}
<div class="row">
    <div class="col d-grid gap-2">
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addEditModal"
                onclick="setupAddEditForAdd();">{#icons/add}{/icons/add} Add Item
        </button>
    </div>
    <div class="col d-grid gap-2">
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addItemFromFileModal">{#icons/addFile}{/icons/addFile} Add Item(s) from file
        </button>
    </div>
    <div class="col d-grid gap-2">
        <button type="button" class="btn btn-info">{#icons/view}{/icons/view} Item stats</button>
    </div>
</div>
<br/>
<div class="row">
    <div class="col accordion" id="searchAccordion">
        <div class="accordion-item">
            <h2 class="accordion-header" id="searchHeader">
                <button class="accordion-button {#if !showSearch}collapsed{/if}" type="button" data-bs-toggle="collapse"
                        data-bs-target="#searchCollapse" aria-expanded="{#if showSearch}true{#else}false{/if}"
                        aria-controls="searchCollapse">
                    Search Fields
                </button>
            </h2>
            <div id="searchCollapse" class="accordion-collapse collapse {#if showSearch}show{/if}"
                 aria-labelledby="searchHeader" data-bs-parent="#searchAccordion">
                <div class="accordion-body">
                    {#search/item/itemSearchForm id='mainStorageSearch'}
                    {/search/item/itemSearchForm}
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col table-responsive">
        <table class=" table table-bordered table-striped table-hover table-sm">
            {#search/item/itemSearchResults searchResults=searchResult actionType='full' searchFormId='mainStorageSearch' pagingCalculations=pagingCalculations}
            {/search/item/itemSearchResults}
        </table>
    </div>
</div>
{#inputs/units/unitOptionsHidden allowedUnitsMap=allowedUnitsMap}
{/inputs/units/unitOptionsHidden}
{#inputs/attInputHidden}
{/inputs/attInputHidden}
{#inputs/keywordInputHidden}
{/inputs/keywordInputHidden}
{#search/image/imageSelectFormInputHidden}
{/search/image/imageSelectFormInputHidden}
{/pageContent}
{#modals}
{#modal id='addEdit' large=true title='Item add/edit' submitForm='addEditItemForm' submitDismiss=false}
    
    <div class="row">
        <div class="col">
            <button type="button" class="btn btn-primary mb-1" onclick="ExtItemSearch.toggleAddEditProductSearchPane();" title="Search for Products">
                {#icons/search}{/icons/search} Search for Products
            </button>
        </div>
    </div>
    <div class="row">
        <div class="col-6 card p-0" id="addEditProductSearchPane">
            <div class="card-header">
                Search for items:
            </div>
            <div class="card-body p-0 h-auto">
                <ul class="nav nav-tabs" id="extItemSearchTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="home" aria-selected="true">Product</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="false">Lego&trade;</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact" type="button" role="tab" aria-controls="contact" aria-selected="false">Website</button>
                    </li>
                </ul>
                <div class="tab-content p-1" id="searchTabContent">
                    <div class="tab-pane fade" id="home" role="tabpanel" aria-labelledby="home-tab">
                        <form id="prodBarcodeSearchForm">
                            <div class="mb-3">
                                <label for="prodBarcodeSearchBarcodeInput" class="form-label">Search with Barcode</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="prodBarcodeSearchBarcodeInput" aria-describedby="barcodeInputHelp" required>
                                    <button class="btn btn-success" type="submit">Search</button>
                                </div>
                                <div id="barcodeInputHelp" class="form-text">Scan in or enter a barcode on a product.</div>
                            </div>
                        </form>
                    </div>
                    <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                        <form id="legoPartNumSearchForm">
                            <div class="mb-3">
                                <label for="legoPartNumSearchInput" class="form-label">Search with Lego&trade; part number</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="legoPartNumSearchInput" aria-describedby="legoPartNumInputHelp" required>
                                    <button class="btn btn-success" type="submit">Search</button>
                                </div>
                                <div id="legoPartNumInputHelp" class="form-text">Most legos have a number on them, it's that parts numbers.</div>
                            </div>
                        </form>
                    </div>
                    <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">
                        <form id="websiteScanSearchForm">
                            <div class="mb-3">
                                <label for="websiteScanSearchInput" class="form-label">Scan a website</label>
                                <div class="input-group">
                                    <input type="url" class="form-control" id="websiteScanSearchInput" aria-describedby="websiteScanInputHelp" required>
                                    <button class="btn btn-success" type="submit">Search</button>
                                </div>
                                <div id="websiteScanInputHelp" class="form-text">Very limited number of supported sites.</div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="card-header">
                Search Results:
            </div>
            <div class="card-body h-100 row" id="extSearchResults">
            </div>
        </div>
        <div class="col">
            <div id="addEditFormMessages"></div>
            <form id="addEditItemForm">
                <input type="hidden" id="addEditFormMode" value="">
                <input type="hidden" id="addEditFormId" value="">
                <div class="mb-3 row">
                    <label for="addEditNameInput" class="col-sm-2 col-form-label">Name</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" id="addEditNameInput" placeholder="Name" required>
                    </div>
                </div>
                <div class="mb-3 row">
                    <label for="addEditDescriptionInput" class="col-sm-2 col-form-label">Description</label>
                    <div class="col-sm-10">
                        <textarea class="form-control" id="addEditDescriptionInput" placeholder="Description"></textarea>
                    </div>
                </div>
                <div class="mb-3 row">
                    <label for="addEditBarcodeInput" class="col-sm-2 col-form-label">Barcode</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" id="addEditBarcodeInput" placeholder="UPC, ISBN...">
                    </div>
                </div>
                <div class="mb-3 row">
                    <label for="addEditStorageTypeInput" class="col-sm-2 col-form-label">Stored Type</label>
                    <div class="col-sm-10">
                        <select class="form-select" id="addEditStorageTypeInput" data-current="AMOUNT_SIMPLE" onchange="addEditStoredTypeInputChanged()">
                            <option value="AMOUNT_SIMPLE" title="hello world" selected>Amount</option>
                            <option value="AMOUNT_LIST">Amount List</option>
                            <option value="TRACKED">Tracked</option>
                        </select>
                    </div>
                </div>
                <div class="mb-3 row" id="trackedItemIdentifierNameRow" style="display: none;">
                    <label for="addEditIdentifyingAttInput" class="col-sm-2 col-form-label">Identifying Attribute</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" id="addEditIdentifyingAttInput" placeholder="Identifying Attribute" required>
                    </div>
                </div>
                <!-- TODO:: default value -->
                <div class="mb-3 row" id="unitNameRow">
                    <label for="addEditUnitInput" class="col-sm-2 col-form-label">Unit</label>
                    <div class="col-sm-10">
                        <select class="form-select" id="addEditUnitInput" onchange="handleItemUnitChange();">
                            {#inputs/units/unitOptionsGroups}
                            {/inputs/units/unitOptionsGroups}
                        </select>
                    </div>
                </div>
                <div class="mb-3 row" id="pricePerUnitNameRow">
                    <label for="addEditPricePerUnitInput" class="col-sm-2 col-form-label">Price Per Unit</label>
                    <div class="col-sm-10">
                        <div class="input-group">
                            <span class="input-group-text" id="addon-wrapping">{currency.getSymbol()}</span>
                            <input type="number" min="0.00" step="any" class="form-control" id="addEditPricePerUnitInput" placeholder="Price Per Unit" required>
                        </div>
                    </div>
                </div>
                <div class="mb-3 row" id="pricePerUnitNameRow">
                    <label for="addEditExpiryWarningThresholdInput" class="col-sm-2 col-form-label">Expiry Warning Threshold</label>
                    <div class="col-sm-10">
                        <div class="input-group">
                            <input type="number" min="0" class="form-control" id="addEditExpiryWarningThresholdInput" placeholder="Expiry Warning Threshold" required value="0" aria-describedby="addEditExpiryWarningThresholdHelp">
                            <select class="form-select" style="max-width: 10em;" id="addEditExpiryWarningThresholdUnitInput">
                                <!-- The values here represent the multiplier to make the equivalent number of seconds for each -->
                                <option value="1">Seconds*</option>
                                <option value="60">Minutes*</option>
                                <option value="3600" selected>Hours</option>
                                <option value="86400">Days</option>
                                <option value="604800">Weeks</option>
                            </select>
                        </div>
                        <div id="addEditExpiryWarningThresholdHelp" class="form-text">
                            How many time units before expiration dates to warn of imminent expiration. 0 for no warning.<br />
                            * = Depending on server settings, you might not get an accurate warning with a short warning period.
                        </div>
                    </div>
                </div>
                <div class="mb-3 row">
                    <label for="addEditTotalLowStockThresholdInput" class="col-sm-2 col-form-label">Total Low Stock Threshold</label>
                    <div class="col-sm-10">
                        <div class="input-group mt-2 mb-3">
                            <input type="number" class="form-control amountStoredValueInput" id="addEditTotalLowStockThresholdInput" placeholder="Value" min="0.00" step="any">
                            <select class="form-select amountStoredUnitInput unitInput" id="addEditTotalLowStockThresholdUnitInput">
                            </select>
                        </div>
                        <div id="addEditTotalLowStockThresholdHelp" class="form-text">
                            The lowest amount to be stored before being marked as low on stock. Leave blank for no threshold.<br />
                            Unit taken from the item's unit.
                        </div>
                    </div>
                </div>
                <hr />
                <div class="mb-3 row">
                    <div class="col-sm-2 col-form-label">Stored</div>
                    <div class="col-sm-10">
                        <div class="accordion mt-2" id="storedContainer">
                
                        </div>
                        <div class="col d-grid gap-2 mt-3">
                            <button type="button" class="btn btn-sm btn-success mt-2" data-bs-toggle="modal" data-bs-target="#storageSearchSelectModal" onclick="storageSearchSelectForm.submit();">
                                {#icons/add}{/icons/add} Add Associated Storage
                            </button>
                        </div>
                    </div>
                </div>
                <hr />
                {#search/image/imageSelectFormInput}
                {/search/image/imageSelectFormInput}
                {#inputs/keywordInput}
                {/inputs/keywordInput}
                {#inputs/attInput}
                {/inputs/attInput}
            </form>
        </div>
    </div>

{/modal}
{#modal id='itemView' large=true title='Item View'}
    <div class="row">
        <div class="col" id="itemViewMessages"></div>
    </div>
<div class="row">
    {#carousel id='itemViewCarousel' carouselCss='col'}{/carousel}
    <div class="col">
        <div class="row">
            <div class="card col-sm-12 col-md-6">
                <div class="card-body">
                    <h5 class="card-title d-inline">Storage Type:</h5>
                    <p id="itemViewStorageType" class="d-inline">
                    </p>
                </div>
            </div>
            <div class="card col-sm-12 col-md-6">
                <div class="card-body">
                    <h5 class="card-title d-inline">Id:</h5>
                    <p class="card-text d-inline">
                        <small>
                            <span id="itemViewId"></span>{#copyTextButton textContainerId='itemViewId'}{/copyTextButton}
                        </small>
                    </p>
                </div>
            </div>
            <div class="card col-12" id="itemViewDescriptionContainer">
                <div class="card-body">
                    <h5 class="card-title">Description:</h5>
                    <div id="itemViewDescription">
                    </div>
                </div>
            </div>
            <div class="card col-sm-12 col-md-6 col-lg-4">
                <div class="card-body">
                    <h5 class="card-title d-inline">Total Held:</h5>
                    <p id="itemViewTotal" class="d-inline">
                    </p>
                </div>
            </div>
            <div class="card col-sm-12 col-md-6 col-lg-4" id="itemViewTotalLowStockThresholdContainer">
                <div class="card-body">
                    <h5 class="card-title d-inline">Total Low Stock Threshold:</h5>
                    <p id="itemViewTotalLowStockThreshold" class="d-inline">
                    </p>
                </div>
            </div>
            <div class="card col-sm-12 col-md-6 col-lg-4">
                <div class="card-body">
                    <h5 class="card-title d-inline">Value per Unit <span id="itemViewValPerUnitDefault">(default)</span>:</h5>
                    <p class="d-inline">
                        {currency.getSymbol()}<span id="itemViewValPerUnit"></span>
                    </p>
                </div>
            </div>
            <div class="card col-sm-12 col-md-6 col-lg-4">
                <div class="card-body">
                    <h5 class="card-title d-inline">Total Value:</h5>
                    <p class="d-inline">
                        {currency.getSymbol()}<span id="itemViewTotalVal"></span>
                    </p>
                </div>
            </div>
            <div class="card col-sm-12 col-md-6 col-lg-4" id="itemViewIdentifyingAttContainer">
                <div class="card-body">
                    <h5 class="card-title d-inline">Identifying Attribute:</h5>
                    <p id="itemViewIdentifyingAtt" class="d-inline">
                    </p>
                </div>
            </div>
            <div class="card col-sm-12 col-md-6 col-lg-4" id="itemViewBarcodeContainer">
                <div class="card-body">
                    <h5 class="card-title">Barcode:</h5>
                    <img src="" id="itemViewBarcode" class="barcodeViewImg" alt="Item Barcode">
                </div>
            </div>
        </div>
        <!-- TODO:: add expiry warning duration -->
    </div>
</div>
<hr />
<div class="row">
    <div class="col">
        <div id="itemViewStoredNonePresentContainer">
            <h4>Nothing Stored</h4>
        </div>
        <div id="itemViewStored">
            <h4>Using <span id="itemViewStoredNum"></span> storage blocks:</h4>
            <div class="col accordion" id="itemViewStoredAccordion">
            </div>
        </div>
    </div>
</div>
<hr />
<div class="row">
    {#objView/objKeywordsView id='viewKeywordsSection' classes='col'}{/objView/objKeywordsView}
    {#objView/objAttsView id='viewAttsSection' classes='col'}{/objView/objAttsView}
</div>
<div class="row">
    <div class="col">
        {#objView/history/objHistoryView containerId='itemHistory' objectUrl='/api/v1/inventory/item/'}{/objView/history/objHistoryView}
    </div>
</div>
{/modal}
{#modal id='addItemFromFile' large=true title='Add item(s) from file' submitForm='addItemFromFileForm' submitDismiss=false}
    <div class="row">
        <div class="col" id="addItemFromFileFormMessages">
        </div>
    </div>
    <!-- TODO:: point to docs on how to do this -->
    <div class="row">
        <div class="col">
            <form id="addItemFromFileForm">
                <div class="col-12 mb-3">
                    <label for="importBulkFileInput" class="form-label">CSV, or JSON file:</label>
                    <input class="form-control" type="file" id="addFromFileInput" name="file" accept="text/csv,application/json" required>
                </div>
            </form>
        </div>
    </div>
{/modal}
{#search/storage/StorageSearchSelectModal otherModalId="addEditModal"}
{/search/storage/StorageSearchSelectModal}
{#search/image/imageSearchSelectModal otherModalId="addEditModal"}
{/search/image/imageSearchSelectModal}
    {#inputs/item/itemAddSubTransModal otherModalId=""}
    {/inputs/item/itemAddSubTransModal}
{/modals}

{#scripts}
    <script src="/lib/Croppie-2.6.4/croppie.min.js"></script>
    <script src="/res/js/obj/media/imageAdd.js"></script>
    <script src="/res/js/obj/media/imageAddFromSelect.js"></script>
    <script src="/res/js/search.js"></script>
    <script src="/res/js/historySearch.js"></script>
    <script src="/res/js/obj/objEdit.js"></script>
    <script src="/res/js/obj/objView.js"></script>
    <script src="/res/js/storedTypeUtils.js"></script>
    <script src="/res/js/obj/media/imageSearchSelect.js"></script>
    <script src="/res/js/obj/storageBlock/storageSearchSelect.js"></script>
    <script src="/res/js/obj/units.js"></script>
    <script src="/res/js/obj/getters.js"></script>
    <script src="/res/js/obj/storageBlock/capacities.js"></script>
    <script src="/res/js/carousel.js"></script>
    <script src="/res/js/item/ItemEditing.js"></script>
    <script src="/res/js/item/ItemAddSubTrans.js"></script>
    <script src="/res/js/obj/storageBlock/storageBlockTree.js"></script>
    <script src="/res/js/textCopy.js"></script>
    <script src="/res/js/item/extItemSearch.js"></script>
    <script src="/res/js/obj/item/itemAddEdit.js"></script>
    <script src="/res/js/obj/item/itemView.js"></script>
{/scripts}
{#pageScript}
<script>
const STORAGE_CLASS = "storageBlock";

var keywordInputTemplate = $('#keywordInputTemplate');
var attInputTemplate = $('#attInputTemplate');
var imageInputTemplate = $('#imageInputTemplate');


var addFromFileInput = $("#addFromFileInput")[0];
var addItemFromFileFormMessages = $("#addItemFromFileFormMessages");

$("#addItemFromFileForm").submit(function (e){
    e.preventDefault();
    
    let formData = new FormData();
    let file = addFromFileInput.files[0];
    
    formData.append("fileName", file.name);
    formData.append("file", file);
    
    doRestCall({
        url: '/api/v1/inventory/item',
        method: "post",
        data: formData,
        done: function (data){
            console.log("Successfully added items.");
            reloadPageWithMessage("Added item(s) successfully!", "success", "Success!");
        },
        failMessagesDiv: addItemFromFileFormMessages
    });
});

</script>
{/pageScript}
{/include}