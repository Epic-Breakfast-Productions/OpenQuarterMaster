# This is a basic workflow to help you get started with Actions

name: Deployment - Repos - Test

# Controls when the workflow will run
on:
  push:
    branches: [ "dev" ]
  pull_request:
    branches: [ "dev" ]
  workflow_call:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    branches: [ "**" ]
defaults:
  run:
    working-directory: "utilities"
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:  # This workflow contains a single job called "build"
  deployToTestRepos:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: sudo apt-get install -y curl dpkg-dev
        
      - name: Setup Signing Key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.OQM_GPG_KEY }}
          passphrase: ${{ secrets.OQM_GPG_KEY_PASS }}
          
      - name: Update Test Repo Files
        run: ./update-test-repositories.sh
        
      - name: Commit new repo files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Updated Repositories after release
          branch: 'update-test-repos-staging-${{ github.ref_name }}'
          create_branch: true
          push_options: '--force'
      - name: Create Pull Request
        uses: actions/github-script@v6
        with:
          script: |
            const { repo, owner } = context.repo;
            const pulls = await github.rest.pulls.list({
              owner: owner,
              repo: repo,
              head: 'update-test-repos-staging-${{ github.ref_name }}',
              base: 'main',
              state: 'open',
            });

            if (pulls.data.length < 1) {
              await github.rest.pulls.create({
                title: '[Delpoy - Repos - Test] Update test repo files for branch ${{ github.ref_name }}',
                owner: owner,
                repo: repo,
                head: 'update-test-repos-staging-${{ github.ref_name }}',
                base: 'main',
                body: [
                  'This PR is auto-generated by',
                  '[actions/github-script](https://github.com/actions/github-script)',
                ].join('\n'),
              });
            } else {
              const existingPR = pulls.data[0];
              await github.rest.pulls.update({
                owner: owner,
                repo: repo,
                pull_number: existingPR.number,
                body: [
                  existingPR.body,
                  `Updated by Job ${context.job}`,
                ].join('\n'),
              });
            }

